name: Test Azure Authentication

on:
  workflow_dispatch:

jobs:
  test-auth:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check if secrets are available
      run: |
        echo "üîç Checking GitHub secrets availability..."
        
        if [ -z "${{ secrets.AZURE_CLIENT_ID }}" ]; then
          echo "‚ùå AZURE_CLIENT_ID secret is missing"
        else
          echo "‚úÖ AZURE_CLIENT_ID secret is set"
        fi
        
        if [ -z "${{ secrets.AZURE_TENANT_ID }}" ]; then
          echo "‚ùå AZURE_TENANT_ID secret is missing"
        else
          echo "‚úÖ AZURE_TENANT_ID secret is set"
        fi
        
        if [ -z "${{ secrets.AZURE_SUBSCRIPTION_ID }}" ]; then
          echo "‚ùå AZURE_SUBSCRIPTION_ID secret is missing"
        else
          echo "‚úÖ AZURE_SUBSCRIPTION_ID secret is set"
        fi
        
        if [ -z "${{ secrets.REGISTRY_PASSWORD }}" ]; then
          echo "‚ùå REGISTRY_PASSWORD secret is missing"
        else
          echo "‚úÖ REGISTRY_PASSWORD secret is set"
        fi
    
    - name: Test Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Verify Azure Access
      run: |
        echo "üîç Testing Azure CLI access..."
        az account show --query "{subscriptionId: id, tenantId: tenantId}" -o table
        
        echo "üîç Testing access to vhealth resource group..."
        az group show --name vhealth --query name -o tsv
        
        echo "üîç Testing Container App access..."
        az containerapp show --name wihy-ui --resource-group vhealth --query name -o tsv
        
        echo "‚úÖ Azure authentication test completed successfully!"