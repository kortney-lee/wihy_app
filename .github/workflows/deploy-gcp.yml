name: Deploy to Google Cloud Platform

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

permissions:
  contents: read
  id-token: write
  security-events: write

env:
  PROJECT_ID: wihy-ai
  GAR_LOCATION: us-central1
  SERVICE: wihy-frontend
  REGION: us-central1
  REPOSITORY: wihy-repo
  CUSTOM_DOMAIN: wihy.ai

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          client/package-lock.json

    - name: Install root dependencies
      run: npm ci

    - name: Install client dependencies
      run: cd client && npm ci

    - name: Security Update - CVE-2025-55182 
      run: |
        cd client
        # Ensure React is at secure version (18.3.1+) to address CVE-2025-55182
        npm list react --depth=0 | grep -q "react@18\.3\.[1-9]" || npm install react@^18.3.1 react-dom@^18.3.1

    - name: Run tests
      run: npm test -- --coverage --watchAll=false

    - name: Run ESLint
      run: cd client && npm run lint || true

    - name: Build application
      run: npm run build

  deploy-frontend-firebase:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          package-lock.json
          client/package-lock.json

    - name: Install root dependencies
      run: npm ci

    - name: Install client dependencies
      run: cd client && npm ci

    - name: Security Update - CVE-2025-55182
      run: |
        cd client
        # Ensure React is at secure version (18.3.1+) to address CVE-2025-55182
        npm list react --depth=0 | grep -q "react@18\.3\.[1-9]" || npm install react@^18.3.1 react-dom@^18.3.1

    - name: Build application
      run: npm run build
      env:
        REACT_APP_API_BASE_URL: ${{ secrets.REACT_APP_API_BASE_URL }}
        REACT_APP_FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ secrets.FIREBASE_AUTH_DOMAIN }}
        REACT_APP_FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ secrets.FIREBASE_STORAGE_BUCKET }}
        REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}
        REACT_APP_FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}

    - name: Deploy to Firebase Hosting
      uses: FirebaseExtended/action-hosting-deploy@v0
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.GCP_SA_KEY }}'
        projectId: '${{ env.PROJECT_ID }}'
        channelId: live

  deploy-backend-cloud-run:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Docker to use gcloud as credential helper
      run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

    - name: Create Artifact Registry repository if not exists
      run: |
        gcloud artifacts repositories describe ${{ env.REPOSITORY }} \
          --location=${{ env.GAR_LOCATION }} || \
        gcloud artifacts repositories create ${{ env.REPOSITORY }} \
          --repository-format=docker \
          --location=${{ env.GAR_LOCATION }} \
          --description="WIHY Health App repository"

    - name: Create Dockerfile for production
      run: |
        cat > Dockerfile.production << EOF
        FROM node:20-alpine AS builder
        WORKDIR /app
        
        # Copy package files for both root and client
        COPY package*.json ./
        COPY client/package*.json ./client/
        
        # Install dependencies for both root and client
        RUN npm ci && npm cache clean --force
        RUN cd client && npm ci && npm cache clean --force
        
        # Copy source code
        COPY . .
        
        # Build the React app
        RUN npm run build

        FROM nginx:alpine
        COPY --from=builder /app/client/build /usr/share/nginx/html
        COPY nginx.conf /etc/nginx/nginx.conf
        
        # Add health check endpoint
        RUN echo 'server { listen 8080; location /health { return 200 "OK"; access_log off; } }' > /etc/nginx/conf.d/health.conf
        
        EXPOSE 8080
        CMD ["nginx", "-g", "daemon off;"]
        EOF

    - name: Create nginx configuration
      run: |
        cat > nginx.conf << EOF
        events {
          worker_connections 1024;
        }
        
        http {
          include /etc/nginx/mime.types;
          default_type application/octet-stream;
          
          sendfile on;
          keepalive_timeout 65;
          gzip on;
          gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
          
          server {
            listen 8080;
            root /usr/share/nginx/html;
            index index.html;
            
            location / {
              try_files \$uri \$uri/ /index.html;
              add_header Cache-Control "public, max-age=31536000";
            }
            
            location /static/ {
              expires 1y;
              add_header Cache-Control "public, immutable";
            }
            
            location /health {
              return 200 "OK";
              access_log off;
            }
          }
        }
        EOF

    - name: Build and push Docker image
      run: |
        docker build -f Dockerfile.production -t ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }} .
        docker push ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }}

    - name: Deploy to Cloud Run
      run: |
        gcloud run deploy ${{ env.SERVICE }} \
          --image ${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/frontend:${{ github.sha }} \
          --platform managed \
          --region ${{ env.REGION }} \
          --allow-unauthenticated \
          --port 8080 \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 5 \
          --timeout 300 \
          --concurrency 100 \
          --set-env-vars="NODE_ENV=production"

    - name: Set up custom domain mapping (if domain exists)
      run: |
        # Set up custom domain for wihy.ai
        gcloud run domain-mappings create \
          --service=${{ env.SERVICE }} \
          --domain=${{ env.CUSTOM_DOMAIN }} \
          --region=${{ env.REGION }} || echo "Domain mapping already exists"

    - name: Get Cloud Run URL
      run: |
        URL=$(gcloud run services describe ${{ env.SERVICE }} --region ${{ env.REGION }} --format 'value(status.url)')
        echo "Frontend deployed to: $URL"
        echo "FRONTEND_URL=$URL" >> $GITHUB_OUTPUT

  deploy-backend-vm:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Create VM instance for backend (if not exists)
      run: |
        # Check if VM exists, if not create it
        if ! gcloud compute instances describe wihy-backend-vm --zone=us-central1-a >/dev/null 2>&1; then
          gcloud compute instances create wihy-backend-vm \
            --zone=us-central1-a \
            --machine-type=e2-medium \
            --image-family=ubuntu-2004-lts \
            --image-project=ubuntu-os-cloud \
            --boot-disk-size=20GB \
            --boot-disk-type=pd-standard \
            --tags=wihy-backend,http-server,https-server \
            --metadata=startup-script='#!/bin/bash
              apt-get update
              apt-get install -y docker.io
              systemctl start docker
              systemctl enable docker
              usermod -aG docker ubuntu
              
              # Install Node.js
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              apt-get install -y nodejs
              
              # Create application directory
              mkdir -p /app
              chown ubuntu:ubuntu /app
              
              # Install Docker Compose
              curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              
              echo "VM setup complete"' || echo "VM already exists or creation failed"
        fi

    - name: Configure firewall rules for VM
      run: |
        # Allow HTTP and HTTPS traffic
        gcloud compute firewall-rules create allow-wihy-backend \
          --allow tcp:80,tcp:443,tcp:3000,tcp:8080 \
          --source-ranges 0.0.0.0/0 \
          --target-tags wihy-backend \
          --description="Allow web traffic for WIHY backend" || echo "Firewall rule exists"

  deploy-backend-services:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Deploy Nutrition Analysis Function
      run: |
        # Create a separate directory for the function
        mkdir -p functions/nutrition
        cd functions/nutrition
        
        cat > index.js << EOF
        const functions = require('@google-cloud/functions-framework');
        const { ImageAnnotatorClient } = require('@google-cloud/vision');
        const { Storage } = require('@google-cloud/storage');

        const storage = new Storage();
        const vision = new ImageAnnotatorClient();

        functions.http('analyzeNutrition', async (req, res) => {
          res.set('Access-Control-Allow-Origin', '*');
          res.set('Access-Control-Allow-Methods', 'POST, OPTIONS');
          res.set('Access-Control-Allow-Headers', 'Content-Type');

          if (req.method === 'OPTIONS') {
            return res.status(204).send('');
          }

          try {
            const { image, imageUrl } = req.body;
            
            let imageBuffer;
            if (image) {
              imageBuffer = Buffer.from(image, 'base64');
            } else if (imageUrl) {
              const response = await fetch(imageUrl);
              imageBuffer = Buffer.from(await response.arrayBuffer());
            } else {
              return res.status(400).json({ error: 'No image provided' });
            }

            // Analyze image with Vision API
            const [result] = await vision.labelDetection({
              image: { content: imageBuffer }
            });

            const labels = result.labelAnnotations || [];
            const foodLabels = labels.filter(label => 
              label.description.toLowerCase().includes('food') ||
              label.description.toLowerCase().includes('fruit') ||
              label.description.toLowerCase().includes('vegetable')
            );

            // Mock nutrition data (replace with actual nutrition API)
            const nutritionData = {
              foodName: foodLabels[0]?.description || 'Unknown Food',
              calories: Math.floor(Math.random() * 300) + 50,
              protein: Math.floor(Math.random() * 30) + 5,
              carbs: Math.floor(Math.random() * 50) + 10,
              fat: Math.floor(Math.random() * 20) + 2,
              fiber: Math.floor(Math.random() * 10) + 1,
              sugar: Math.floor(Math.random() * 15) + 2,
              confidence: foodLabels[0]?.score || 0.5
            };

            res.json({
              success: true,
              data: nutritionData,
              labels: foodLabels
            });

          } catch (error) {
            console.error('Error analyzing nutrition:', error);
            res.status(500).json({
              success: false,
              error: 'Failed to analyze nutrition'
            });
          }
        });
        EOF

        cat > package.json << EOF
        {
          "name": "nutrition-function",
          "version": "1.0.0",
          "main": "index.js",
          "scripts": {
            "start": "functions-framework --target=analyzeNutrition --port=8080"
          },
          "dependencies": {
            "@google-cloud/functions-framework": "^3.0.0",
            "@google-cloud/storage": "^7.0.0",
            "@google-cloud/vision": "^4.0.0"
          },
          "engines": {
            "node": ">=20.0.0"
          }
        }
        EOF

        gcloud functions deploy nutrition-analysis \
          --gen2 \
          --runtime=nodejs20 \
          --region=${{ env.REGION }} \
          --source=. \
          --entry-point=analyzeNutrition \
          --trigger-http \
          --allow-unauthenticated \
          --memory=1GB \
          --timeout=60s \
          --set-env-vars="PORT=8080"

  setup-security-and-networking:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Configure Cloud Armor Security Policy
      run: |
        # Create security policy for DDoS protection
        gcloud compute security-policies create wihy-security-policy \
          --description="Security policy for WIHY Health App" || echo "Policy exists"
        
        # Add rate limiting rule
        gcloud compute security-policies rules create 1000 \
          --security-policy=wihy-security-policy \
          --expression="true" \
          --action=rate-based-ban \
          --rate-limit-threshold-count=100 \
          --rate-limit-threshold-interval-sec=60 \
          --ban-duration-sec=600 || echo "Rule exists"

    - name: Enable required security APIs
      run: |
        gcloud services enable cloudkms.googleapis.com
        gcloud services enable secretmanager.googleapis.com

    - name: Create SSL certificate (if custom domain)
      run: |
        gcloud compute ssl-certificates create wihy-ssl-cert \
          --domains=${{ env.CUSTOM_DOMAIN }} \
          --global || echo "SSL certificate already exists"

  setup-monitoring:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Enable monitoring and logging
      run: |
        gcloud services enable monitoring.googleapis.com
        gcloud services enable logging.googleapis.com
        gcloud services enable cloudtrace.googleapis.com

    - name: Create uptime check
      run: |
        cat > uptime-check.json << EOF
        {
          "displayName": "WIHY Frontend Uptime Check",
          "monitoredResource": {
            "type": "uptime_url",
            "labels": {}
          },
          "httpCheck": {
            "useSsl": true,
            "path": "/health",
            "port": 443
          },
          "timeout": "10s",
          "period": "60s"
        }
        EOF
        
        # Create uptime check (will need the actual URL after deployment)
        echo "Uptime check configuration ready"

  setup-database:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}

    - name: Create Firestore database if not exists
      run: |
        # Check if Firestore is already initialized
        gcloud firestore databases describe --database="(default)" || \
        gcloud firestore databases create --database="(default)" --location=nam5

    - name: Deploy Firestore rules
      run: |
        cat > firestore.rules << EOF
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Users can read and write their own data
            match /users/{userId} {
              allow read, write: if request.auth != null && request.auth.uid == userId;
            }
            
            // Public nutrition data
            match /nutrition/{document=**} {
              allow read: if true;
              allow write: if request.auth != null;
            }
            
            // User meals - private to user
            match /meals/{mealId} {
              allow read, write: if request.auth != null && 
                resource.data.userId == request.auth.uid;
            }
          }
        }
        EOF

        # Install Firebase CLI and deploy rules
        npm install -g firebase-tools
        firebase use ${{ env.PROJECT_ID }}
        firebase deploy --only firestore:rules

  security-scan:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies for security scan
      run: |
        npm ci
        cd client && npm ci

    - name: CVE-2025-55182 Security Check
      run: |
        cd client
        echo "Checking for CVE-2025-55182 (React vulnerability)..."
        REACT_VERSION=$(npm list react --depth=0 | grep react@ | cut -d'@' -f2 | cut -d' ' -f1)
        echo "Current React version: $REACT_VERSION"
        
        # Check if React version is vulnerable (anything below 18.3.1)
        if [ "$(printf '%s\n' "18.3.1" "$REACT_VERSION" | sort -V | head -n1)" != "18.3.1" ]; then
          echo "âŒ VULNERABLE: React version $REACT_VERSION is vulnerable to CVE-2025-55182"
          echo "Please update to React 18.3.1 or higher"
          exit 1
        else
          echo "âœ… SECURE: React version $REACT_VERSION is not vulnerable to CVE-2025-55182"
        fi

    - name: Run npm audit
      run: |
        cd client
        npm audit --audit-level high || echo "Security vulnerabilities found"

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: 'trivy-results.sarif'
      if: always()

  notify-deployment:
    needs: [deploy-frontend-firebase, deploy-backend-cloud-run, deploy-backend-services, setup-security-and-networking, setup-monitoring]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Get deployment status
      run: |
        echo "Deployment completed!"
        echo "Frontend Status: ${{ needs.deploy-frontend-firebase.result }}"
        echo "Backend Status: ${{ needs.deploy-backend-cloud-run.result }}"
        echo "Services Status: ${{ needs.deploy-backend-services.result }}"
        echo "Security Status: ${{ needs.setup-security-and-networking.result }}"
        echo "Monitoring Status: ${{ needs.setup-monitoring.result }}"
        echo ""
        echo "ðŸ”’ SSL/TLS: Automatically enabled on all GCP services"
        echo "ðŸŒ Frontend URL: https://${{ env.CUSTOM_DOMAIN }} (Custom Domain)"
        echo "ðŸŒ Firebase URL: https://${{ env.PROJECT_ID }}.web.app (Backup)"
        echo "âš¡ Backend URL: Available after Cloud Run deployment"
        echo "ðŸ“Š Monitoring: Cloud Operations enabled"