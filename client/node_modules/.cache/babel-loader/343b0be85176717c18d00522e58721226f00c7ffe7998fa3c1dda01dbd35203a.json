{"ast":null,"code":"import{API_CONFIG,getApiEndpoint}from'../config/apiConfig';import{logger}from'../utils/logger';// ==================== WIHY API CORRECT INTERFACES ====================\n// Chart Data Structures based on documentation\n// NOVA Classification\n// Ask Endpoint Interfaces\n// Scan Endpoint Interfaces\n// Chat Endpoint Interfaces\n// Request Interfaces\n// Main Response Wrapper\n// Interface for processed scan results following integration guide\n// Types for the WiHy Enhanced Model API (2,325 training examples)\n// Enhanced Model Response Structure\n// Image Scanner Response Structure\n// Barcode Scanner Response Structure  \n// Legacy interfaces for backward compatibility\n// Chart data structure from OpenAPI spec\n// Core response data structure from OpenAPI spec\n// Main response structure from OpenAPI spec\n// Keep the old interface for backward compatibility\n// Interface for the /scan endpoint\n// Type guard for detecting unified responses at runtime\nexport function isUnifiedResponse(obj){return obj&&typeof obj==='object'&&'data'in obj&&'service_used'in obj;}// Legacy types for backward compatibility\nclass WihyEnhancedAPIService{constructor(){this.baseURL=void 0;this.isLocalDevelopment=void 0;this.baseURL=API_CONFIG.WIHY_API_URL;this.isLocalDevelopment=this.baseURL.includes('localhost');}/**\r\n   * Ask WiHy Enhanced Model a health-related question (2,325 training examples)\r\n   */async askEnhancedHealthQuestion(request){try{logger.apiRequest('Making WiHy Enhanced Model API request',request);const endpoint=\"\".concat(this.baseURL,\"/ask\");// Use fetch API with timeout and retry logic\nconst controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),30000);// 30 second timeout\nconst response=await this.fetchWithRetry(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(request),signal:controller.signal});clearTimeout(timeoutId);if(!response.ok){throw new Error(\"HTTP error! status: \".concat(response.status));}const data=await response.json();logger.apiResponse('WiHy Enhanced Model API response received',data);return data;}catch(error){logger.error('WiHy Enhanced Model API error:',error);throw this.handleEnhancedError(error);}}/**\r\n   * Scan food image using enhanced vision analysis\r\n   */async scanFoodImage(imageFile){let context=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'';try{const formData=new FormData();formData.append('image',imageFile);formData.append('context',context);const endpoint=getApiEndpoint('scan');const controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),45000);// 45 second timeout for images\nconst response=await this.fetchWithRetry(endpoint,{method:'POST',body:formData,signal:controller.signal});clearTimeout(timeoutId);if(!response.ok){throw new Error(\"HTTP error! status: \".concat(response.status));}const data=await response.json();logger.apiResponse('WiHy Image Scanner response received',data);return data;}catch(error){logger.error('WiHy Image Scanner error:',error);throw this.handleScannerError(error,'image');}}/**\r\n   * Scan barcode using enhanced nutrition database (via /ask endpoint)\r\n   */async scanBarcode(barcode){let context=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};try{// Use the /ask endpoint with barcode-specific query format (per integration guide)\nconst requestBody={query:\"Analyze barcode: \".concat(barcode),user_context:{scan_location:context.scan_location||'web_app',device_type:context.device_type||'desktop',user_type:context.user_type||'general'}};const endpoint=getApiEndpoint('ask');// Points to /ask endpoint\nconst controller=new AbortController();const timeoutId=setTimeout(()=>controller.abort(),20000);// 20 second timeout\nconst response=await this.fetchWithRetry(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(requestBody),signal:controller.signal});clearTimeout(timeoutId);if(!response.ok){throw new Error(\"HTTP error! status: \".concat(response.status));}const data=await response.json();logger.apiResponse('WiHy Barcode Scanner response received',data);// Process the response to extract NOVA and health data\nreturn this.processBarcodeScanResponse(data,barcode);}catch(error){logger.error('WiHy Barcode Scanner error:',error);throw this.handleScannerError(error,'barcode');}}/**\r\n   * Process barcode scan response to extract NOVA and health data (per integration guide)\r\n   */processBarcodeScanResponse(result,barcode){const analysis=result.analysis||result;const{nova_group,nova_classification,food_quality_score,research_quality_score,health_verdict,addiction_analysis,ingredient_analysis}=analysis;return{success:true,nova_group:nova_group||4,health_score:food_quality_score||0,product_name:analysis.product_name||\"Product \".concat(barcode),ingredients:analysis.ingredients||[],nutritional_data:{calories_per_100g:analysis.calories_per_100g||0,protein_g:analysis.protein_g||0,carbs_g:analysis.carbs_g||0,fat_g:analysis.fat_g||0,fiber_g:analysis.fiber_g||0,sodium_mg:analysis.sodium_mg||0},health_analysis:{carcinogen_alerts:(addiction_analysis===null||addiction_analysis===void 0?void 0:addiction_analysis.addictive_components)||[],toxic_additives:analysis.toxic_additives||[],processing_level:nova_classification||'Ultra-processed'},wihy_recommendations:analysis.recommendations||[],data_sources:result.research_citations||['WiHy Enhanced Database','OpenFoodFacts']};}/**\r\n   * Check API health and get status\r\n   */async checkAPIHealth(){try{const response=await fetch(getApiEndpoint('health'),{method:'GET',headers:{'Accept':'application/json'}});if(!response.ok){throw new Error(\"Health check failed: \".concat(response.status));}return await response.json();}catch(error){logger.error('WiHy API health check failed:',error);throw error;}}/**\r\n   * Fetch with simple retry logic (single endpoint only)\r\n   */async fetchWithRetry(url,options){let retries=arguments.length>2&&arguments[2]!==undefined?arguments[2]:2;let lastError;for(let attempt=0;attempt<=retries;attempt++){try{const response=await fetch(url,options);return response;// Return response for error handling upstream\n}catch(error){lastError=error;logger.warn(\"Attempt \".concat(attempt+1,\" failed for \").concat(this.baseURL,\":\"),error);// If this is the last attempt, throw error\nif(attempt===retries){throw lastError;}// Wait before retry (exponential backoff)\nawait new Promise(resolve=>setTimeout(resolve,1000*Math.pow(2,attempt)));}}throw lastError;}/**\r\n   * Enhanced error handling for API responses\r\n   */handleEnhancedError(error){if(error instanceof Error){// Check for timeout/abort errors\nif(error.name==='AbortError'){return new Error('TIMEOUT_ERROR: Enhanced model request timed out - services may be under heavy load');}// Check for CORS errors\nif(error.message.includes('CORS')||error.message.includes('Access to fetch')||error.message.includes('No \\'Access-Control-Allow-Origin\\'')){return new Error('CORS_ERROR: Unable to connect to WiHy Enhanced Model from this domain');}// Check for network/connectivity issues\nif(error.message.includes('fetch')||error.message.includes('network')||error.name==='TypeError'||error.message.includes('Failed to fetch')){return new Error('NETWORK_ERROR: Unable to connect to WiHy Enhanced Model services');}// Check for server errors\nif(error.message.includes('HTTP error! status: 5')){return new Error('SERVER_ERROR: WiHy Enhanced Model temporarily unavailable');}return new Error(error.message||'WiHy Enhanced Model request failed');}return new Error('Unknown error occurred while contacting WiHy Enhanced Model');}/**\r\n   * Scanner-specific error handling\r\n   */handleScannerError(error,scanType){const context=scanType==='image'?'Image Scanner':'Barcode Scanner';if(error instanceof Error){if(error.name==='AbortError'){return new Error(\"TIMEOUT_ERROR: \".concat(context,\" request timed out\"));}if(error.message.includes('HTTP error! status: 400')){return new Error(\"VALIDATION_ERROR: Invalid \".concat(scanType,\" format or data\"));}if(error.message.includes('HTTP error! status: 404')){return new Error(\"NOT_FOUND: \".concat(scanType==='barcode'?'Product not found in nutrition databases':'Unable to analyze image'));}return new Error(\"\".concat(context.toUpperCase(),\"_ERROR: \").concat(error.message));}return new Error(\"Unknown \".concat(context.toLowerCase(),\" error occurred\"));}/**\r\n   * Legacy compatibility method - Ask WiHy a health-related question\r\n   * Now routes to Enhanced Model ONLY (no fallbacks)\r\n   */async askAnything(request){try{// Convert legacy request to enhanced format\nconst enhancedRequest={query:request.query,context:'user_context'in request?JSON.stringify(request.user_context):'',user_id:'user_id'in request?request.user_id:undefined};// Use enhanced model ONLY\nconst enhancedResponse=await this.askEnhancedHealthQuestion(enhancedRequest);// Convert enhanced response to legacy format for backward compatibility\nreturn this.convertEnhancedToLegacy(enhancedResponse,request.query);}catch(error){logger.error('Enhanced WiHy API failed:',error);throw error;}}/**\r\n   * Convert Enhanced Model response to legacy format for backward compatibility\r\n   */convertEnhancedToLegacy(enhancedResponse,originalQuery){return{success:true,timestamp:enhancedResponse.timestamp||new Date().toISOString(),response_type:'enhanced_model',query:originalQuery,wihy_response:{query_type:'enhanced_model',query:originalQuery,core_principle:enhancedResponse.answer,personalized_analysis:{identified_risk_factors:[],priority_health_goals:[enhancedResponse.answer],action_items:enhancedResponse.wihy_wisdom.map((wisdom,index)=>({action:wisdom,priority:'high',target_illness:'general_health',evidence_level:'enhanced_model',mechanism:'biblical_wisdom',timeline:'immediate'})),timeline:'immediate'},research_foundation:enhancedResponse.research_citations.map(citation=>({citation_text:citation,study_type:'enhanced_model_research',key_finding:citation})),progress_tracking:{key_metrics:['enhanced_health_understanding'],reassessment_period:'1 week'},biblical_wisdom:enhancedResponse.wihy_wisdom},message:enhancedResponse.answer};}/**\r\n   * Convert UnifiedResponse to legacy WihyResponse format for backward compatibility\r\n   */convertToLegacyFormat(unifiedResponse,originalQuery){var _unifiedResponse$data,_unifiedResponse$data2,_unifiedResponse$data3,_unifiedResponse$data4;// Handle chat service response\nif(unifiedResponse.service_used==='chat'&&unifiedResponse.data.response){return{success:unifiedResponse.success,timestamp:new Date().toISOString(),response_type:unifiedResponse.request_type,query:originalQuery,wihy_response:{query_type:unifiedResponse.request_type,query:originalQuery,core_principle:unifiedResponse.data.response,personalized_analysis:{identified_risk_factors:[],priority_health_goals:[unifiedResponse.data.response],action_items:[{action:unifiedResponse.data.response,priority:'medium',target_illness:'general_health',evidence_level:'ai_generated',mechanism:'chat_response',timeline:'immediate'}],timeline:'immediate'},research_foundation:[{citation_text:'WiHy AI Chat System',study_type:'ai_response',key_finding:unifiedResponse.data.response}],progress_tracking:{key_metrics:['general_health'],reassessment_period:'1 week'},biblical_wisdom:[]},message:unifiedResponse.data.response};}// Handle other service types (training, nutrition, etc.)\nreturn{success:unifiedResponse.success,timestamp:new Date().toISOString(),response_type:unifiedResponse.request_type,query:originalQuery,wihy_response:{query_type:unifiedResponse.request_type,query:originalQuery,core_principle:unifiedResponse.data.analysis||unifiedResponse.data.response||'Health Information',personalized_analysis:{identified_risk_factors:[],priority_health_goals:[],action_items:((_unifiedResponse$data=unifiedResponse.data.recommendations)===null||_unifiedResponse$data===void 0?void 0:(_unifiedResponse$data2=_unifiedResponse$data.immediate_actions)===null||_unifiedResponse$data2===void 0?void 0:_unifiedResponse$data2.map((rec,index)=>({action:rec,priority:'medium',target_illness:'general_health',evidence_level:'moderate',mechanism:'lifestyle_modification',timeline:'ongoing'})))||((_unifiedResponse$data3=unifiedResponse.data.legacy_recommendations)===null||_unifiedResponse$data3===void 0?void 0:_unifiedResponse$data3.map((rec,index)=>({action:rec,priority:'medium',target_illness:'general_health',evidence_level:'moderate',mechanism:'lifestyle_modification',timeline:'ongoing'})))||[],timeline:'ongoing'},research_foundation:((_unifiedResponse$data4=unifiedResponse.data.sources)===null||_unifiedResponse$data4===void 0?void 0:_unifiedResponse$data4.map(source=>({citation_text:source,study_type:'research',key_finding:source})))||[],progress_tracking:{key_metrics:['general_health'],reassessment_period:'1 month'},biblical_wisdom:[]},message:unifiedResponse.data.response||unifiedResponse.data.analysis||'Health information provided'};}/**\r\n   * Get health news articles using the unified API\r\n   */async getHealthNews(categories,limit){const query=categories&&categories.length>0?\"Latest health news about \".concat(categories.join(', ')):'Latest health news';const request={query:query,request_type:'health',context:{categories:categories,limit:limit}};const response=await this.askAnything(request);if('data'in response){// It's a UnifiedResponse, convert to legacy format\nreturn this.convertToLegacyFormat(response,query);}return response;}/**\r\n   * Search for nutrition information using the unified API\r\n   */async searchNutrition(foodQuery,userContext){const request={query:\"Nutrition information for \".concat(foodQuery),request_type:'nutrition',context:userContext||{}};const response=await this.askAnything(request);if('data'in response){// It's a UnifiedResponse, convert to legacy format\nreturn this.convertToLegacyFormat(response,request.query);}return response;}/**\r\n   * Legacy scan food images method - now uses enhanced scanner\r\n   */async scanFood(file,scanOptions){try{if(file){// Use enhanced image scanner\nconst enhancedResponse=await this.scanFoodImage(file,scanOptions!==null&&scanOptions!==void 0&&scanOptions.user_context?JSON.stringify(scanOptions.user_context):'');// Convert to legacy format\nreturn this.convertImageScanToLegacy(enhancedResponse,'Image scan analysis');}else if(scanOptions!==null&&scanOptions!==void 0&&scanOptions.barcode){// Use enhanced barcode scanner\nconst enhancedResponse=await this.scanBarcode(scanOptions.barcode,scanOptions.user_context);// Convert to legacy format\nreturn this.convertBarcodeScanToLegacy(enhancedResponse,\"Barcode scan: \".concat(scanOptions.barcode));}else{throw new Error('No file or barcode provided for scanning');}}catch(error){logger.error('WiHy Scan error:',error);throw error;}}/**\r\n   * Convert Image Scanner response to legacy format\r\n   */convertImageScanToLegacy(response,query){var _response$overall_ass,_response$data_source;const recommendations=response.wihy_recommendations||[];const warnings=response.carcinogen_warnings||[];return{success:response.success,timestamp:new Date().toISOString(),response_type:'image_scan',query:query,wihy_response:{query_type:'image_scan',query:query,core_principle:((_response$overall_ass=response.overall_assessment)===null||_response$overall_ass===void 0?void 0:_response$overall_ass.verdict)||'Image analysis complete',personalized_analysis:{identified_risk_factors:warnings.map(warning=>({risk_factor:warning,associated_illnesses:'various',prevalence_rate:0,preventability_score:100})),priority_health_goals:recommendations,action_items:recommendations.map(rec=>({action:rec,priority:'high',target_illness:'general_health',evidence_level:'image_analysis',mechanism:'food_choice',timeline:'immediate'})),timeline:'immediate'},research_foundation:((_response$data_source=response.data_sources)===null||_response$data_source===void 0?void 0:_response$data_source.map(source=>({citation_text:source,study_type:'database',key_finding:source})))||[],progress_tracking:{key_metrics:['food_quality_awareness'],reassessment_period:'1 week'},biblical_wisdom:['Choose foods that nourish your temple - 1 Corinthians 6:19']},message:this.formatImageScanResponse(response)};}/**\r\n   * Convert Barcode Scanner response to legacy format\r\n   */convertBarcodeScanToLegacy(response,query){var _response$health_anal,_response$health_anal2,_response$data_source2;const recommendations=response.wihy_recommendations||[];const warnings=[...(((_response$health_anal=response.health_analysis)===null||_response$health_anal===void 0?void 0:_response$health_anal.carcinogen_alerts)||[]),...(((_response$health_anal2=response.health_analysis)===null||_response$health_anal2===void 0?void 0:_response$health_anal2.toxic_additives)||[])];return{success:response.success,timestamp:new Date().toISOString(),response_type:'barcode_scan',query:query,wihy_response:{query_type:'barcode_scan',query:query,core_principle:\"Product Analysis: \".concat(response.product_name),personalized_analysis:{identified_risk_factors:warnings.map(warning=>({risk_factor:warning,associated_illnesses:'various',prevalence_rate:0,preventability_score:100})),priority_health_goals:recommendations,action_items:recommendations.map(rec=>({action:rec,priority:'high',target_illness:'general_health',evidence_level:'product_analysis',mechanism:'ingredient_awareness',timeline:'immediate'})),timeline:'immediate'},research_foundation:((_response$data_source2=response.data_sources)===null||_response$data_source2===void 0?void 0:_response$data_source2.map(source=>({citation_text:source,study_type:'nutrition_database',key_finding:source})))||[],progress_tracking:{key_metrics:['product_awareness','nova_understanding'],reassessment_period:'1 week'},biblical_wisdom:['Real food doesn\\'t need complicated analysis - choose whole foods']},message:this.formatBarcodeScanResponse(response)};}/**\r\n   * Convert File to base64 string\r\n   */fileToBase64(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.readAsDataURL(file);reader.onload=()=>{const result=reader.result;// Remove the data:image/jpeg;base64, prefix\nconst base64=result.split(',')[1];resolve(base64);};reader.onerror=error=>reject(error);});}/**\r\n   * General health search using the unified API (single call only)\r\n   */async searchHealth(query,userContext){var _Error$stack;const timestamp=new Date().toISOString();const callId=Math.random().toString(36).substr(2,9);logger.info(\"\\uD83D\\uDD0D [\".concat(callId,\"] WiHy searchHealth called at \").concat(timestamp),{query,userContext,stack:(_Error$stack=new Error().stack)===null||_Error$stack===void 0?void 0:_Error$stack.split('\\n').slice(1,4).map(line=>line.trim())});const request={query:query,request_type:'auto',context:userContext||{}};const response=await this.askAnything(request);logger.info(\"\\u2705 [\".concat(callId,\"] WiHy searchHealth completed at \").concat(new Date().toISOString()),{query,responseType:response.constructor.name,success:response.success,duration:\"\".concat(Date.now()-new Date(timestamp).getTime(),\"ms\")});// Return the raw response (could be legacy WihyResponse or UnifiedResponse)\nreturn response;}/**\r\n   * Get NOVA classification guidance (per integration guide)\r\n   */getNovaGuidance(novaGroup){const guidance={1:{action:'CHOOSE',color:'green',message:'Real food as God intended'},2:{action:'MODERATE',color:'yellow',message:'Use sparingly'},3:{action:'LIMIT',color:'orange',message:'Find alternatives'},4:{action:'AVOID',color:'red',message:'Your family deserves better'}};return guidance[novaGroup]||guidance[4];}/**\r\n   * Process WiHy response following integration guide patterns\r\n   */processWihyResponse(result){const analysis=result.analysis||result;const{nova_group,nova_classification,food_quality_score,research_quality_score,health_verdict,addiction_analysis,recommendations}=analysis;const novaGroup=nova_group||4;const guidance=this.getNovaGuidance(novaGroup);return{isHealthy:novaGroup<=2&&(food_quality_score||0)>=60,novaGroup:novaGroup,healthScore:food_quality_score||0,researchQuality:research_quality_score||0,verdict:health_verdict||'Unknown',addictionScore:(addiction_analysis===null||addiction_analysis===void 0?void 0:addiction_analysis.addiction_score)||0,recommendations:recommendations||[],warnings:(addiction_analysis===null||addiction_analysis===void 0?void 0:addiction_analysis.addictive_components)||[],familySafe:(food_quality_score||0)>=60,colorCode:guidance.color,rawResponse:result};}/**\r\n   * Format Enhanced Model response for display in the UI\r\n   */formatEnhancedResponse(response){let formatted=\"# WiHy Enhanced Health Intelligence\\n\\n\";// Main response content\nformatted+=response.answer;// Add research citations if available\nif(response.research_citations&&response.research_citations.length>0){formatted+=\"\\n\\n## \\uD83D\\uDCDA Research Citations\\n\";response.research_citations.forEach((citation,index)=>{formatted+=\"\".concat(index+1,\". \").concat(citation,\"\\n\");});}// Add biblical wisdom if available\nif(response.wihy_wisdom&&response.wihy_wisdom.length>0){formatted+=\"\\n\\n## \\u271D\\uFE0F Biblical Wisdom\\n\";response.wihy_wisdom.forEach(wisdom=>{formatted+=\"> \".concat(wisdom,\"\\n\\n\");});}// Add enhanced model info\nformatted+=\"\\n\\n---\\n\\n\";formatted+=\"*Enhanced Model Response (\".concat(response.training_examples_used,\" training examples)*\\n\");formatted+=\"*Confidence Score: \".concat(Math.round(response.confidence_score*100),\"%*\\n\");formatted+=\"*Model Version: \".concat(response.model_version,\"*\");return formatted;}/**\r\n   * Format Image Scanner response for display\r\n   */formatImageScanResponse(response){let formatted=\"# \\uD83D\\uDCF7 WiHy Image Analysis Results\\n\\n\";if(response.success&&response.overall_assessment){var _response$nova_chart_;const{health_score,verdict,nova_group}=response.overall_assessment;const guidance=(_response$nova_chart_=response.nova_chart_reference)===null||_response$nova_chart_===void 0?void 0:_response$nova_chart_.client_guidance;formatted+=\"## Health Assessment\\n\";formatted+=\"**Health Score:** \".concat(health_score,\"/100\\n\");formatted+=\"**Verdict:** \".concat(verdict,\"\\n\");formatted+=\"**NOVA Group:** \".concat(nova_group,\" (\").concat(this.getNovaLabel(nova_group),\")\\n\");if(guidance){formatted+=\"**Recommendation:** \".concat(guidance.action,\" - \").concat(guidance.message,\"\\n\\n\");}// Detected foods\nif(response.detected_foods&&response.detected_foods.length>0){formatted+=\"## \\uD83C\\uDF7D\\uFE0F Detected Foods\\n\";response.detected_foods.forEach(food=>{formatted+=\"- **\".concat(food.name,\"** (Confidence: \").concat(Math.round(food.confidence*100),\"%, NOVA: \").concat(food.nova_group,\")\\n\");});formatted+='\\n';}// WIHY recommendations\nif(response.wihy_recommendations&&response.wihy_recommendations.length>0){formatted+=\"## \\uD83D\\uDCA1 WIHY Recommendations\\n\";response.wihy_recommendations.forEach(rec=>{formatted+=\"- \".concat(rec,\"\\n\");});formatted+='\\n';}// Health warnings\nif(response.carcinogen_warnings&&response.carcinogen_warnings.length>0){formatted+=\"## \\u26A0\\uFE0F Health Warnings\\n\";response.carcinogen_warnings.forEach(warning=>{formatted+=\"- \".concat(warning,\"\\n\");});formatted+='\\n';}// Family safety\nif(response.family_safety){formatted+=\"## \\uD83D\\uDC68\\u200D\\uD83D\\uDC69\\u200D\\uD83D\\uDC67\\u200D\\uD83D\\uDC66 Family Safety\\n\";formatted+=\"**Status:** \".concat(response.family_safety.family_safe?'✅ Safe':'❌ Not Recommended',\"\\n\");formatted+=\"**Verdict:** \".concat(response.family_safety.family_verdict,\"\\n\\n\");}}else{formatted+=\"Analysis failed. Please try again or choose whole foods when in doubt.\\n\\n\";}// Data sources\nif(response.data_sources&&response.data_sources.length>0){formatted+=\"---\\n\\n*Data sources: \".concat(response.data_sources.join(', '),\"*\");}return formatted;}/**\r\n   * Format Barcode Scanner response for display\r\n   */formatBarcodeScanResponse(response){let formatted=\"# \\uD83D\\uDD0D WiHy Barcode Analysis\\n\\n\";if(response.success){formatted+=\"## Product Information\\n\";formatted+=\"**Product:** \".concat(response.product_name,\"\\n\");formatted+=\"**Health Score:** \".concat(response.health_score,\"/100\\n\");formatted+=\"**NOVA Group:** \".concat(response.nova_group,\" (\").concat(this.getNovaLabel(response.nova_group),\")\\n\\n\");// Nutritional data\nif(response.nutritional_data){const nutrition=response.nutritional_data;formatted+=\"## \\uD83D\\uDCCA Nutrition Facts (per 100g)\\n\";formatted+=\"- **Calories:** \".concat(nutrition.calories_per_100g,\"\\n\");formatted+=\"- **Protein:** \".concat(nutrition.protein_g,\"g\\n\");formatted+=\"- **Carbohydrates:** \".concat(nutrition.carbs_g,\"g\\n\");formatted+=\"- **Fat:** \".concat(nutrition.fat_g,\"g\\n\");formatted+=\"- **Fiber:** \".concat(nutrition.fiber_g,\"g\\n\");formatted+=\"- **Sodium:** \".concat(nutrition.sodium_mg,\"mg\\n\\n\");}// Health analysis\nif(response.health_analysis){const analysis=response.health_analysis;formatted+=\"## \\uD83D\\uDD2C Health Analysis\\n\";formatted+=\"**Processing Level:** \".concat(analysis.processing_level,\"\\n\");if(analysis.carcinogen_alerts&&analysis.carcinogen_alerts.length>0){formatted+=\"**\\u26A0\\uFE0F Carcinogen Alerts:**\\n\";analysis.carcinogen_alerts.forEach(alert=>{formatted+=\"- \".concat(alert,\"\\n\");});}if(analysis.toxic_additives&&analysis.toxic_additives.length>0){formatted+=\"**\\uD83E\\uDDEA Toxic Additives:**\\n\";analysis.toxic_additives.forEach(additive=>{formatted+=\"- \".concat(additive,\"\\n\");});}formatted+='\\n';}// WIHY recommendations\nif(response.wihy_recommendations&&response.wihy_recommendations.length>0){formatted+=\"## \\uD83D\\uDCA1 WIHY Recommendations\\n\";response.wihy_recommendations.forEach(rec=>{formatted+=\"- \".concat(rec,\"\\n\");});formatted+='\\n';}// Ingredients\nif(response.ingredients&&response.ingredients.length>0){formatted+=\"## \\uD83E\\uDDFE Ingredients\\n\";formatted+=response.ingredients.join(', ')+'\\n\\n';}}else{formatted+=\"Product not found or analysis failed. Choose foods with 5 or fewer ingredients when in doubt.\\n\\n\";}// Data sources\nif(response.data_sources&&response.data_sources.length>0){formatted+=\"---\\n\\n*Data sources: \".concat(response.data_sources.join(', '),\"*\");}return formatted;}/**\r\n   * Get NOVA group label\r\n   */getNovaLabel(novaGroup){const labels={1:'Natural/Unprocessed',2:'Processed Culinary Ingredients',3:'Processed Foods',4:'Ultra-Processed Foods'};return labels[novaGroup]||'Unknown';}/**\r\n   * Format WiHy Response in user-friendly format for display\r\n   */formatWihyResponse(response){var _wihy_response$resear,_wihy_response$biblic;// Handle new HealthQuestionResponse format (OpenAPI v4.0.0)\nif('success'in response&&'data'in response&&response.data&&'response'in response.data&&'processor_used'in response.data){const healthResp=response;const data=healthResp.data;let formatted=\"# WiHy Health Intelligence\\n\\n\";// Main response content\nformatted+=data.response;// Add health insights if available\nif(data.health_insights){var _data$health_insights,_data$health_insights2,_data$health_insights3;if((_data$health_insights=data.health_insights.key_benefits)!==null&&_data$health_insights!==void 0&&_data$health_insights.length){formatted+=\"\\n\\n## \\uD83C\\uDF1F Key Benefits\\n\";data.health_insights.key_benefits.forEach(benefit=>{formatted+=\"- \".concat(benefit,\"\\n\");});}if((_data$health_insights2=data.health_insights.potential_risks)!==null&&_data$health_insights2!==void 0&&_data$health_insights2.length){formatted+=\"\\n\\n## \\u26A0\\uFE0F Potential Risks\\n\";data.health_insights.potential_risks.forEach(risk=>{formatted+=\"- \".concat(risk,\"\\n\");});}if((_data$health_insights3=data.health_insights.recommendations)!==null&&_data$health_insights3!==void 0&&_data$health_insights3.length){formatted+=\"\\n\\n## \\uD83D\\uDCCB Recommendations\\n\";data.health_insights.recommendations.forEach(rec=>{formatted+=\"- \".concat(rec,\"\\n\");});}}// Add processing info\nformatted+=\"\\n\\n---\\n\\n*Processed by \".concat(data.processor_used,\" in \").concat(data.processing_time.toFixed(2),\"ms*\");return formatted;}// Handle UnifiedResponse format (legacy API)\nif('success'in response&&'data'in response&&response.data&&'ai_response'in response.data){var _unifiedResp$data$ai_;const unifiedResp=response;let formatted=\"# WiHy Health Assistant\\n\\n\";// Use the ai_response.response field which contains the actual response\nif(unifiedResp.data.ai_response&&unifiedResp.data.ai_response.response){formatted+=unifiedResp.data.ai_response.response;}else{// Fallback to showing raw data if ai_response is not available\nformatted+=\"**Data:**\\n```json\\n\".concat(JSON.stringify(unifiedResp.data,null,2),\"\\n```\");}// Add service information if available\nif((_unifiedResp$data$ai_=unifiedResp.data.ai_response)!==null&&_unifiedResp$data$ai_!==void 0&&_unifiedResp$data$ai_.service){formatted+=\"\\n\\n---\\n\\n*Response from \".concat(unifiedResp.data.ai_response.service,\" service*\");if(unifiedResp.data.ai_response.confidence){formatted+=\" (Confidence: \".concat(Math.round(unifiedResp.data.ai_response.confidence*100),\"%)\");}}return formatted;}// Handle legacy WihyResponse format\nconst legacyResp=response;const{wihy_response}=legacyResp;let formatted=\"# \".concat(wihy_response.core_principle,\"\\n\\n\");// Personalized Analysis\nif(wihy_response.personalized_analysis){var _wihy_response$person,_wihy_response$person2,_wihy_response$person3;formatted+=\"## \\uD83C\\uDFAF Personalized Health Analysis\\n\\n\";// Risk Factors\nif(((_wihy_response$person=wihy_response.personalized_analysis.identified_risk_factors)===null||_wihy_response$person===void 0?void 0:_wihy_response$person.length)>0){formatted+=\"### Identified Risk Factors:\\n\";wihy_response.personalized_analysis.identified_risk_factors.forEach(risk=>{formatted+=\"- **\".concat(risk.risk_factor.replace(/_/g,' ').toUpperCase(),\"**\\n\");formatted+=\"  - Associated with: \".concat(risk.associated_illnesses.replace(/_/g,' '),\"\\n\");formatted+=\"  - Prevalence: \".concat(risk.prevalence_rate,\"%\\n\");formatted+=\"  - Preventability: \".concat(risk.preventability_score,\"%\\n\\n\");});}// Priority Goals\nif(((_wihy_response$person2=wihy_response.personalized_analysis.priority_health_goals)===null||_wihy_response$person2===void 0?void 0:_wihy_response$person2.length)>0){formatted+=\"### \\uD83C\\uDFAF Priority Health Goals:\\n\";wihy_response.personalized_analysis.priority_health_goals.forEach(goal=>{formatted+=\"- \".concat(goal,\"\\n\");});formatted+='\\n';}// Action Items\nif(((_wihy_response$person3=wihy_response.personalized_analysis.action_items)===null||_wihy_response$person3===void 0?void 0:_wihy_response$person3.length)>0){formatted+=\"### \\uD83D\\uDCCB Action Items:\\n\";wihy_response.personalized_analysis.action_items.forEach((action,index)=>{formatted+=\"#### \".concat(index+1,\". \").concat(action.action,\"\\n\");formatted+=\"- **Priority:** \".concat(action.priority,\"\\n\");formatted+=\"- **Target:** \".concat(action.target_illness.replace(/_/g,' '),\"\\n\");formatted+=\"- **Evidence Level:** \".concat(action.evidence_level,\"\\n\");formatted+=\"- **How it works:** \".concat(action.mechanism,\"\\n\");formatted+=\"- **Timeline:** \".concat(action.timeline,\"\\n\\n\");});}// Timeline\nif(wihy_response.personalized_analysis.timeline){formatted+=\"**Implementation Timeline:** \".concat(wihy_response.personalized_analysis.timeline,\"\\n\\n\");}}// Research Foundation\nif(((_wihy_response$resear=wihy_response.research_foundation)===null||_wihy_response$resear===void 0?void 0:_wihy_response$resear.length)>0){formatted+=\"## \\uD83D\\uDCDA Research Foundation\\n\\n\";wihy_response.research_foundation.forEach(research=>{formatted+=\"- **\".concat(research.citation_text,\"** (\").concat(research.study_type,\")\\n\");formatted+=\"  \".concat(research.key_finding,\"\\n\\n\");});}// Progress Tracking\nif(wihy_response.progress_tracking){formatted+=\"## \\uD83D\\uDCCA Progress Tracking\\n\\n\";formatted+=\"**Key Metrics to Track:**\\n\";wihy_response.progress_tracking.key_metrics.forEach(metric=>{formatted+=\"- \".concat(metric,\"\\n\");});formatted+=\"\\n**Reassessment:** \".concat(wihy_response.progress_tracking.reassessment_period,\"\\n\\n\");}// Biblical Wisdom\nif(((_wihy_response$biblic=wihy_response.biblical_wisdom)===null||_wihy_response$biblic===void 0?void 0:_wihy_response$biblic.length)>0){formatted+=\"## \\u271D\\uFE0F Biblical Wisdom\\n\\n\";wihy_response.biblical_wisdom.forEach(wisdom=>{formatted+=\"> \".concat(wisdom,\"\\n\\n\");});}// Add timestamp if available (different field names in different response formats)\nconst timestamp=response.timestamp||response.created_at||new Date().toISOString();formatted+=\"---\\n\\n*WiHy health truth analysis generated at: \".concat(new Date(timestamp).toLocaleString(),\"*\\n\");return formatted;}/**\r\n   * Extract recommendations from WiHy response for UI display\r\n   */extractRecommendations(response){const recommendations=[];// Handle new HealthQuestionResponse format (OpenAPI v4.0.0)\nif('success'in response&&'data'in response&&response.data&&'health_insights'in response.data){const healthResp=response;if(healthResp.data.health_insights.recommendations){healthResp.data.health_insights.recommendations.forEach(r=>recommendations.push(r));}return recommendations;}if(isUnifiedResponse(response)){// Handle new structured recommendations\nif(response.data.recommendations){const recs=response.data.recommendations;if(recs.immediate_actions)recs.immediate_actions.forEach(r=>recommendations.push(r));if(recs.lifestyle_changes)recs.lifestyle_changes.forEach(r=>recommendations.push(r));if(recs.better_alternatives)recs.better_alternatives.forEach(r=>recommendations.push(r));if(recs.shopping_tips)recs.shopping_tips.forEach(r=>recommendations.push(r));if(recs.meal_planning)recs.meal_planning.forEach(r=>recommendations.push(r));}// Handle legacy recommendations\nif(response.data.legacy_recommendations&&response.data.legacy_recommendations.length>0){response.data.legacy_recommendations.forEach(r=>recommendations.push(r));}}else{var _legacyResp$wihy_resp;// Handle legacy WihyResponse format\nconst legacyResp=response;if((_legacyResp$wihy_resp=legacyResp.wihy_response.personalized_analysis)!==null&&_legacyResp$wihy_resp!==void 0&&_legacyResp$wihy_resp.action_items){legacyResp.wihy_response.personalized_analysis.action_items.forEach(action=>{recommendations.push(\"\".concat(action.action,\" (\").concat(action.priority,\" priority)\"));});}}return recommendations;}/**\r\n   * Extract citations from WiHy response for UI display\r\n   */extractCitations(response){const citations=[];// Handle new HealthQuestionResponse format (OpenAPI v4.0.0)\nif('success'in response&&'data'in response&&response.data&&'processor_used'in response.data){// For now, the new API doesn't include specific citation fields in the schema\n// We could parse citations from the response text if needed\nreturn citations;}if(isUnifiedResponse(response)){// Unified API may include sources array\nif(response.data.sources&&response.data.sources.length>0){response.data.sources.forEach(s=>citations.push(s));}}else{// Handle legacy WihyResponse format\nconst legacyResp=response;if(legacyResp.wihy_response.research_foundation){legacyResp.wihy_response.research_foundation.forEach(research=>{citations.push(\"\".concat(research.citation_text,\": \").concat(research.key_finding));});}}return citations;}/**\r\n   * Format UnifiedResponse for chat display (simple format)\r\n   */formatUnifiedResponseForChat(response){// Handle chat service responses\nif(response.service_used==='chat'&&response.data.response){// For now, the API is returning very brief responses like \"AI Chat response to: what is healthy\"\n// We should provide more helpful information to the user\nconst briefResponse=response.data.response;if(briefResponse.includes('AI Chat response to:')){// The API gave us a placeholder response, provide something more useful\nconst query=response.data.query||'your question';return\"I received your question about \\\"\".concat(query,\"\\\" and I'm here to help! \\n\\nThe WiHy AI system is currently processing health-related queries. While the response system is being optimized, I can help you with:\\n\\n\\u2022 Understanding health and nutrition concepts\\n\\u2022 Providing general wellness guidance  \\n\\u2022 Explaining health data and metrics\\n\\u2022 Offering evidence-based health insights\\n\\nWhat specific aspect of health would you like to explore further?\");}return briefResponse;}// Handle other response types\nif(response.data.response){return response.data.response;}if(response.data.analysis){return response.data.analysis;}if(response.data.training_status){let message=\"\\uD83D\\uDD04 \".concat(response.data.training_status);if(response.data.available_models&&response.data.available_models.length>0){message+=\"\\n\\n\\uD83D\\uDCCA Available models: \".concat(response.data.available_models.join(', '));}return message;}// Fallback - show the raw data in a readable format\nreturn\"I received a response from the \".concat(response.service_used,\" service. Here's what I found:\\n\\n\").concat(JSON.stringify(response.data,null,2));}}// Export a singleton instance of the enhanced API service\nexport const wihyAPI=new WihyEnhancedAPIService();// ==================== NEW WIHY API v3.0.0 SERVICE ====================\nexport class WihyAPIService{constructor(){this.apiKey=void 0;this.baseUrl=void 0;this.apiKey=process.env.REACT_APP_WIHY_API_KEY||'';this.baseUrl=API_CONFIG.WIHY_API_URL;}// Health check endpoint\nasync healthCheck(){try{const response=await fetch(getApiEndpoint('health'),{method:'GET',headers:{'Authorization':\"Bearer \".concat(this.apiKey),'Content-Type':'application/json'}});if(!response.ok){throw new Error(\"HTTP \".concat(response.status,\": \").concat(response.statusText));}return await response.json();}catch(error){logger.error('WIHY health check failed:',error);throw error;}}// Ask endpoint - general health questions\nasync ask(request){try{const response=await fetch(getApiEndpoint('ask'),{method:'POST',headers:{'Authorization':\"Bearer \".concat(this.apiKey),'Content-Type':'application/json'},body:JSON.stringify(request)});if(!response.ok){throw new Error(\"HTTP \".concat(response.status,\": \").concat(response.statusText));}const data=await response.json();return data.response;}catch(error){logger.error('WIHY ask request failed:',error);throw error;}}// Scan endpoint - product/barcode scanning\nasync scan(request){try{const response=await fetch(getApiEndpoint('scan'),{method:'POST',headers:{'Authorization':\"Bearer \".concat(this.apiKey),'Content-Type':'application/json'},body:JSON.stringify(request)});if(!response.ok){throw new Error(\"HTTP \".concat(response.status,\": \").concat(response.statusText));}const data=await response.json();return data.response;}catch(error){logger.error('WIHY scan request failed:',error);throw error;}}// Chat endpoint - conversational health coaching\nasync chat(request){try{const response=await fetch(getApiEndpoint('chat'),{method:'POST',headers:{'Authorization':\"Bearer \".concat(this.apiKey),'Content-Type':'application/json'},body:JSON.stringify(request)});if(!response.ok){throw new Error(\"HTTP \".concat(response.status,\": \").concat(response.statusText));}const data=await response.json();return data.response;}catch(error){logger.error('WIHY chat request failed:',error);throw error;}}// Legacy compatibility methods for existing code integration\nasync scanBarcode(barcode,options){try{var _scanResponse$detaile,_scanResponse$detaile2,_scanResponse$detaile3,_scanResponse$detaile4,_scanResponse$detaile5;const scanRequest={barcode,user_context:{include_charts:true,include_ingredients:true,enhanced_analysis:(options===null||options===void 0?void 0:options.enhanced)||false}};const scanResponse=await this.scan(scanRequest);// Convert new response format to legacy format for compatibility\nreturn{productName:(_scanResponse$detaile=scanResponse.detailed_analysis.scan_metadata)===null||_scanResponse$detaile===void 0?void 0:_scanResponse$detaile.product_name,ingredients:(_scanResponse$detaile2=scanResponse.detailed_analysis.ingredients_analysis)===null||_scanResponse$detaile2===void 0?void 0:_scanResponse$detaile2.map(ing=>ing.ingredient),nutritionInfo:this.extractNutritionInfo(scanResponse),healthScore:scanResponse.confidence_score,alerts:scanResponse.detailed_analysis.health_risks||[],recommendations:scanResponse.recommendations,barcode:(_scanResponse$detaile3=scanResponse.detailed_analysis.scan_metadata)===null||_scanResponse$detaile3===void 0?void 0:_scanResponse$detaile3.barcode,brand:(_scanResponse$detaile4=scanResponse.detailed_analysis.scan_metadata)===null||_scanResponse$detaile4===void 0?void 0:_scanResponse$detaile4.brand,categories:(_scanResponse$detaile5=scanResponse.detailed_analysis.scan_metadata)===null||_scanResponse$detaile5===void 0?void 0:_scanResponse$detaile5.categories,confidence_score:scanResponse.confidence_score};}catch(error){logger.error('Legacy barcode scan failed:',error);throw error;}}async scanImage(imageBase64,options){try{var _scanResponse$detaile6,_scanResponse$detaile7;const scanRequest={image:imageBase64,user_context:{include_charts:true,include_ingredients:true,enhanced_analysis:(options===null||options===void 0?void 0:options.enhanced)||false}};const scanResponse=await this.scan(scanRequest);// Convert new response format to legacy format for compatibility\nreturn{productName:(_scanResponse$detaile6=scanResponse.detailed_analysis.scan_metadata)===null||_scanResponse$detaile6===void 0?void 0:_scanResponse$detaile6.product_name,ingredients:(_scanResponse$detaile7=scanResponse.detailed_analysis.ingredients_analysis)===null||_scanResponse$detaile7===void 0?void 0:_scanResponse$detaile7.map(ing=>ing.ingredient),nutritionInfo:this.extractNutritionInfo(scanResponse),healthScore:scanResponse.confidence_score,alerts:scanResponse.detailed_analysis.health_risks||[],recommendations:scanResponse.recommendations,confidence_score:scanResponse.confidence_score};}catch(error){logger.error('Legacy image scan failed:',error);throw error;}}extractNutritionInfo(scanResponse){// Extract nutrition info from charts if available\nconst nutritionChart=scanResponse.charts.ingredient_health_impact;if(!nutritionChart)return undefined;// This is a simplified extraction - in practice, you might need more complex parsing\n// based on the actual chart data structure\nreturn{// These would need to be extracted from the chart data or metadata\n// For now, returning undefined as the exact mapping depends on chart structure\ncalories:undefined,protein:undefined,carbs:undefined,fat:undefined,sugar:undefined,sodium:undefined,fiber:undefined};}}// Export new API service instance\nexport const wihyAPIv3=new WihyAPIService();export default wihyAPI;","map":{"version":3,"names":["API_CONFIG","getApiEndpoint","logger","isUnifiedResponse","obj","WihyEnhancedAPIService","constructor","baseURL","isLocalDevelopment","WIHY_API_URL","includes","askEnhancedHealthQuestion","request","apiRequest","endpoint","concat","controller","AbortController","timeoutId","setTimeout","abort","response","fetchWithRetry","method","headers","body","JSON","stringify","signal","clearTimeout","ok","Error","status","data","json","apiResponse","error","handleEnhancedError","scanFoodImage","imageFile","context","arguments","length","undefined","formData","FormData","append","handleScannerError","scanBarcode","barcode","requestBody","query","user_context","scan_location","device_type","user_type","processBarcodeScanResponse","result","analysis","nova_group","nova_classification","food_quality_score","research_quality_score","health_verdict","addiction_analysis","ingredient_analysis","success","health_score","product_name","ingredients","nutritional_data","calories_per_100g","protein_g","carbs_g","fat_g","fiber_g","sodium_mg","health_analysis","carcinogen_alerts","addictive_components","toxic_additives","processing_level","wihy_recommendations","recommendations","data_sources","research_citations","checkAPIHealth","fetch","url","options","retries","lastError","attempt","warn","Promise","resolve","Math","pow","name","message","scanType","toUpperCase","toLowerCase","askAnything","enhancedRequest","user_id","enhancedResponse","convertEnhancedToLegacy","originalQuery","timestamp","Date","toISOString","response_type","wihy_response","query_type","core_principle","answer","personalized_analysis","identified_risk_factors","priority_health_goals","action_items","wihy_wisdom","map","wisdom","index","action","priority","target_illness","evidence_level","mechanism","timeline","research_foundation","citation","citation_text","study_type","key_finding","progress_tracking","key_metrics","reassessment_period","biblical_wisdom","convertToLegacyFormat","unifiedResponse","_unifiedResponse$data","_unifiedResponse$data2","_unifiedResponse$data3","_unifiedResponse$data4","service_used","request_type","immediate_actions","rec","legacy_recommendations","sources","source","getHealthNews","categories","limit","join","searchNutrition","foodQuery","userContext","scanFood","file","scanOptions","convertImageScanToLegacy","convertBarcodeScanToLegacy","_response$overall_ass","_response$data_source","warnings","carcinogen_warnings","overall_assessment","verdict","warning","risk_factor","associated_illnesses","prevalence_rate","preventability_score","formatImageScanResponse","_response$health_anal","_response$health_anal2","_response$data_source2","formatBarcodeScanResponse","fileToBase64","reject","reader","FileReader","readAsDataURL","onload","base64","split","onerror","searchHealth","_Error$stack","callId","random","toString","substr","info","stack","slice","line","trim","responseType","duration","now","getTime","getNovaGuidance","novaGroup","guidance","color","processWihyResponse","isHealthy","healthScore","researchQuality","addictionScore","addiction_score","familySafe","colorCode","rawResponse","formatEnhancedResponse","formatted","forEach","training_examples_used","round","confidence_score","model_version","_response$nova_chart_","nova_chart_reference","client_guidance","getNovaLabel","detected_foods","food","confidence","family_safety","family_safe","family_verdict","nutrition","alert","additive","labels","formatWihyResponse","_wihy_response$resear","_wihy_response$biblic","healthResp","health_insights","_data$health_insights","_data$health_insights2","_data$health_insights3","key_benefits","benefit","potential_risks","risk","processor_used","processing_time","toFixed","_unifiedResp$data$ai_","unifiedResp","ai_response","service","legacyResp","_wihy_response$person","_wihy_response$person2","_wihy_response$person3","replace","goal","research","metric","created_at","toLocaleString","extractRecommendations","r","push","recs","lifestyle_changes","better_alternatives","shopping_tips","meal_planning","_legacyResp$wihy_resp","extractCitations","citations","s","formatUnifiedResponseForChat","briefResponse","training_status","available_models","wihyAPI","WihyAPIService","apiKey","baseUrl","process","env","REACT_APP_WIHY_API_KEY","healthCheck","statusText","ask","scan","chat","_scanResponse$detaile","_scanResponse$detaile2","_scanResponse$detaile3","_scanResponse$detaile4","_scanResponse$detaile5","scanRequest","include_charts","include_ingredients","enhanced_analysis","enhanced","scanResponse","productName","detailed_analysis","scan_metadata","ingredients_analysis","ing","ingredient","nutritionInfo","extractNutritionInfo","alerts","health_risks","brand","scanImage","imageBase64","_scanResponse$detaile6","_scanResponse$detaile7","image","nutritionChart","charts","ingredient_health_impact","calories","protein","carbs","fat","sugar","sodium","fiber","wihyAPIv3"],"sources":["C:/repo/wihy_ui/client/src/services/wihyAPI.ts"],"sourcesContent":["import { API_CONFIG, getApiEndpoint } from '../config/apiConfig';\r\nimport { logger } from '../utils/logger';\r\n\r\n// ==================== WIHY API CORRECT INTERFACES ====================\r\n\r\n// Chart Data Structures based on documentation\r\nexport interface ChartDataPoint {\r\n  label?: string;\r\n  value?: number;\r\n  percentage?: number;\r\n  color: string;\r\n  category?: string;\r\n  source?: string;\r\n  grain?: string;\r\n  ingredient?: string;\r\n  food_group?: string;\r\n  score?: number;\r\n  impact_score?: number;\r\n  servings?: string;\r\n}\r\n\r\nexport interface PieChartData {\r\n  type: 'pie_chart' | 'donut_chart';\r\n  title: string;\r\n  data: ChartDataPoint[];\r\n}\r\n\r\nexport interface RadarChartData {\r\n  type: 'radar_chart';\r\n  title: string;\r\n  data: {\r\n    categories: string[];\r\n    values: number[];\r\n    max_value: number;\r\n  };\r\n}\r\n\r\nexport interface BarChartData {\r\n  type: 'bar_chart' | 'horizontal_bar_chart';\r\n  title: string;\r\n  data: ChartDataPoint[];\r\n  scale?: string;\r\n}\r\n\r\nexport interface LineChartData {\r\n  type: 'line_chart';\r\n  title: string;\r\n  data: {\r\n    x_axis: string[];\r\n    systolic?: number[];\r\n    diastolic?: number[];\r\n    target_systolic?: number;\r\n    target_diastolic?: number;\r\n    [key: string]: any;\r\n  };\r\n}\r\n\r\nexport interface GaugeChartData {\r\n  type: 'gauge_chart';\r\n  title: string;\r\n  data: {\r\n    current_value: number;\r\n    recommended_max: number;\r\n    units: string;\r\n    warning_threshold: number;\r\n    danger_threshold: number;\r\n    colors: {\r\n      safe: string;\r\n      warning: string;\r\n      danger: string;\r\n    };\r\n  };\r\n}\r\n\r\n// NOVA Classification\r\nexport interface NovaClassification {\r\n  group: number;\r\n  description: string;\r\n  explanation: string;\r\n}\r\n\r\n// Ask Endpoint Interfaces\r\nexport interface NutritionalProfile {\r\n  protein: string;\r\n  fiber: string;\r\n  carbohydrates: string;\r\n  fat: string;\r\n  micronutrients: string[];\r\n}\r\n\r\nexport interface AskDetailedAnalysis {\r\n  nova_classification: NovaClassification;\r\n  nutritional_profile?: NutritionalProfile;\r\n  health_benefits?: string[];\r\n  considerations?: string[];\r\n}\r\n\r\nexport interface AskResponse {\r\n  summary: string;\r\n  detailed_analysis: AskDetailedAnalysis;\r\n  recommendations: string[];\r\n  charts: {\r\n    nutritional_breakdown?: PieChartData;\r\n    health_score_radar?: RadarChartData;\r\n    comparison_bar?: BarChartData;\r\n    [key: string]: any;\r\n  };\r\n  confidence_score: number;\r\n}\r\n\r\n// Scan Endpoint Interfaces\r\nexport interface IngredientAnalysis {\r\n  ingredient: string;\r\n  amount: string;\r\n  health_impact: string;\r\n  concerns: string[];\r\n}\r\n\r\nexport interface NutritionalConcerns {\r\n  sugar_content: string;\r\n  empty_calories: string;\r\n  sodium: string;\r\n}\r\n\r\nexport interface ScanMetadata {\r\n  barcode?: string;\r\n  product_name?: string;\r\n  brand?: string;\r\n  categories?: string[];\r\n  data_source?: string;\r\n  last_updated?: string;\r\n}\r\n\r\nexport interface ScanDetailedAnalysis {\r\n  nova_classification: NovaClassification;\r\n  ingredients_analysis?: IngredientAnalysis[];\r\n  nutritional_concerns?: NutritionalConcerns;\r\n  health_risks?: string[];\r\n  scan_metadata?: ScanMetadata;\r\n}\r\n\r\nexport interface ScanResponse {\r\n  summary: string;\r\n  detailed_analysis: ScanDetailedAnalysis;\r\n  recommendations: string[];\r\n  charts: {\r\n    ingredient_health_impact?: BarChartData;\r\n    nova_classification_breakdown?: PieChartData;\r\n    daily_intake_warning?: GaugeChartData;\r\n    [key: string]: any;\r\n  };\r\n  confidence_score: number;\r\n}\r\n\r\n// Chat Endpoint Interfaces\r\nexport interface FoodCategory {\r\n  category: string;\r\n  examples: string[];\r\n  benefit?: string;\r\n  reason?: string;\r\n}\r\n\r\nexport interface ConversationMetadata {\r\n  conversation_id?: string;\r\n  message_id?: string;\r\n  user_context?: {\r\n    health_condition?: string;\r\n    dietary_preferences?: string[];\r\n    previous_topics?: string[];\r\n    [key: string]: any;\r\n  };\r\n  follow_up_questions?: string[];\r\n}\r\n\r\nexport interface ChatDetailedAnalysis {\r\n  dietary_approach?: string;\r\n  foods_to_include?: FoodCategory[];\r\n  foods_to_avoid?: FoodCategory[];\r\n  lifestyle_factors?: string[];\r\n}\r\n\r\nexport interface ChatResponse {\r\n  summary: string;\r\n  detailed_analysis: ChatDetailedAnalysis;\r\n  recommendations: string[];\r\n  charts: {\r\n    dash_diet_pyramid?: any;\r\n    blood_pressure_impact?: LineChartData;\r\n    sodium_sources?: PieChartData;\r\n    potassium_vs_sodium?: any;\r\n    [key: string]: any;\r\n  };\r\n  conversation_metadata?: ConversationMetadata;\r\n  confidence_score: number;\r\n}\r\n\r\n// Request Interfaces\r\nexport interface WiHyAskRequest {\r\n  query: string;\r\n  user_id?: string;\r\n  context?: string;\r\n}\r\n\r\nexport interface WiHyScanRequest {\r\n  barcode?: string;\r\n  image?: string;\r\n  product_name?: string;\r\n  user_context?: {\r\n    include_charts?: boolean;\r\n    include_ingredients?: boolean;\r\n    enhanced_analysis?: boolean;\r\n    [key: string]: any;\r\n  };\r\n}\r\n\r\nexport interface WiHyChatRequest {\r\n  message: string;\r\n  user_id?: string;\r\n  conversation_id?: string;\r\n  context?: {\r\n    health_condition?: string;\r\n    age?: number;\r\n    dietary_preferences?: string[];\r\n    [key: string]: any;\r\n  };\r\n}\r\n\r\n// Main Response Wrapper\r\nexport interface WiHyApiResponse {\r\n  response: AskResponse | ScanResponse | ChatResponse;\r\n  timestamp: string;\r\n  processing_time: number;\r\n}\r\n\r\n// Interface for processed scan results following integration guide\r\ninterface ProcessedScanResult {\r\n  isHealthy: boolean;\r\n  novaGroup: number;\r\n  healthScore: number;\r\n  researchQuality: number;\r\n  verdict: string;\r\n  addictionScore: number;\r\n  recommendations: string[];\r\n  warnings: string[];\r\n  familySafe: boolean;\r\n  colorCode: 'green' | 'yellow' | 'orange' | 'red';\r\n  rawResponse: any;\r\n}\r\n\r\n// Types for the WiHy Enhanced Model API (2,325 training examples)\r\nexport interface EnhancedHealthQuestion {\r\n  query: string;                          // REQUIRED: Your health/nutrition question\r\n  context?: string;                       // OPTIONAL: Additional context for the question\r\n  user_id?: string;                       // OPTIONAL: User identifier for personalization\r\n}\r\n\r\n// Enhanced Model Response Structure\r\nexport interface EnhancedHealthResponse {\r\n  question: string;\r\n  answer: string;\r\n  research_citations: string[];\r\n  wihy_wisdom: string[];\r\n  confidence_score: number;\r\n  model_version: string;\r\n  training_examples_used: number;\r\n  timestamp: string;\r\n}\r\n\r\n// Image Scanner Response Structure\r\nexport interface ImageScanResponse {\r\n  success: boolean;\r\n  overall_assessment: {\r\n    health_score: number;\r\n    verdict: string;\r\n    nova_group: number;\r\n  };\r\n  google_vision_analysis: {\r\n    vision_api_success: boolean;\r\n    detected_text: string[];\r\n    labels: string[];\r\n  };\r\n  detected_foods: Array<{\r\n    name: string;\r\n    confidence: number;\r\n    nova_group: number;\r\n  }>;\r\n  nova_chart_reference: {\r\n    client_guidance: {\r\n      color_coding: 'green' | 'yellow' | 'orange' | 'red';\r\n      action: 'CHOOSE' | 'MODERATE' | 'LIMIT' | 'AVOID';\r\n      message: string;\r\n    };\r\n  };\r\n  wihy_recommendations: string[];\r\n  carcinogen_warnings: string[];\r\n  family_safety: {\r\n    family_safe: boolean;\r\n    family_verdict: string;\r\n  };\r\n  data_sources: string[];\r\n}\r\n\r\n// Barcode Scanner Response Structure  \r\nexport interface BarcodeScanResponse {\r\n  success: boolean;\r\n  nova_group: number;\r\n  health_score: number;\r\n  product_name: string;\r\n  ingredients: string[];\r\n  nutritional_data: {\r\n    calories_per_100g: number;\r\n    protein_g: number;\r\n    carbs_g: number;\r\n    fat_g: number;\r\n    fiber_g: number;\r\n    sodium_mg: number;\r\n  };\r\n  health_analysis: {\r\n    carcinogen_alerts: string[];\r\n    toxic_additives: string[];\r\n    processing_level: string;\r\n  };\r\n  wihy_recommendations: string[];\r\n  data_sources: string[];\r\n}\r\n\r\n// Legacy interfaces for backward compatibility\r\nexport interface HealthQuestion {\r\n  query: string;                          // REQUIRED: Your health/nutrition question\r\n  user_context?: Record<string, any>;     // OPTIONAL: User context object\r\n  include_nutrition?: boolean;            // OPTIONAL: Include nutrition analysis (default: true)\r\n  include_biblical_wisdom?: boolean;      // OPTIONAL: Include biblical wisdom (default: true)\r\n  include_charts?: boolean;               // OPTIONAL: Include chart data (default: true)\r\n}\r\n\r\n// Chart data structure from OpenAPI spec\r\nexport interface ChartData {\r\n  chart_type: string;\r\n  labels: string[];\r\n  values: number[];\r\n  colors: string[];\r\n  verdict?: string;\r\n  reasons?: string[];\r\n}\r\n\r\nexport interface ChartsData {\r\n  nutrition_breakdown?: ChartData;\r\n  health_quality?: ChartData;\r\n}\r\n\r\nexport interface HealthInsights {\r\n  key_benefits?: string[];\r\n  potential_risks?: string[];\r\n  recommendations?: string[];\r\n}\r\n\r\n// Core response data structure from OpenAPI spec\r\nexport interface ProcessedHealthData {\r\n  query: string;\r\n  timestamp: number;\r\n  processor_used: string;\r\n  processing_time: number;\r\n  response: string;\r\n  nutrition_data: Record<string, any>;\r\n  health_insights: HealthInsights;\r\n  biblical_wisdom: Record<string, any>;\r\n  charts_data: ChartsData;\r\n}\r\n\r\n// Main response structure from OpenAPI spec\r\nexport interface HealthQuestionResponse {\r\n  success: boolean;\r\n  timestamp: string;\r\n  endpoint: string;\r\n  data: ProcessedHealthData;\r\n}\r\n\r\n// Keep the old interface for backward compatibility\r\nexport interface UnifiedRequest extends HealthQuestion {\r\n  request_type?: 'auto' | 'nutrition' | 'health' | 'chat' | 'auth' | 'predict' | 'train';\r\n  context?: Record<string, any>;\r\n  user_id?: string;\r\n  session_id?: string;\r\n}\r\n\r\n// Interface for the /scan endpoint\r\nexport interface ScanRequest {\r\n  image_url?: string;                     // OPTIONAL: URL to image\r\n  image_base64?: string;                  // OPTIONAL: Base64 encoded image\r\n  product_name?: string;                  // OPTIONAL: Product name to scan\r\n  barcode?: string;                       // OPTIONAL: Barcode/UPC to scan  \r\n  user_context?: Record<string, any>;     // OPTIONAL: User context object\r\n}\r\n\r\nexport interface UnifiedResponse {\r\n  success: boolean;\r\n  data: {\r\n    ai_response: {\r\n      response: string;\r\n      enhanced: boolean;\r\n      service: string;\r\n      confidence: number;\r\n    };\r\n    nutrition?: {\r\n      facts: {\r\n        calories_per_serving: number;\r\n        protein_g: number;\r\n        carbs_g: number;\r\n        fiber_g: number;\r\n        fat_g: number;\r\n        sodium_mg: number;\r\n        sugar_g: number;\r\n      };\r\n      nourish_score: {\r\n        score: number;\r\n        category: string;\r\n        breakdown: {\r\n          nutrient_density: number;\r\n          processing_level: number;\r\n          ingredient_quality: number;\r\n        };\r\n      };\r\n      daily_value_percentages: Record<string, number>;\r\n      macronutrients: { protein: number; carbs: number; fat: number };\r\n      micronutrients: string[];\r\n    };\r\n    health_analysis?: {\r\n      safety_score: number;\r\n      carcinogen_alerts: string[];\r\n      toxic_additives: string[];\r\n      processing_level: string;\r\n      ingredient_analysis: Array<{\r\n        name: string;\r\n        safety_score: number;\r\n        category: string;\r\n        concerns: string[];\r\n        benefits: string[];\r\n      }>;\r\n    };\r\n    charts_data?: {\r\n      nutrition_breakdown: {\r\n        labels: string[];\r\n        values: number[];\r\n        colors: string[];\r\n        chart_type: string;\r\n      };\r\n      ingredient_safety_radar: {\r\n        labels: string[];\r\n        values: number[];\r\n        max_value: number;\r\n        chart_type: string;\r\n      };\r\n      daily_nutrition_progress: {\r\n        nutrients: Array<{\r\n          name: string;\r\n          current: number;\r\n          target: number;\r\n          color: string;\r\n        }>;\r\n        chart_type: string;\r\n      };\r\n    };\r\n    recommendations?: {\r\n      immediate_actions: string[];\r\n      lifestyle_changes: string[];\r\n      better_alternatives: string[];\r\n      shopping_tips: string[];\r\n      meal_planning: string[];\r\n    };\r\n    evidence?: {\r\n      research_studies: string[];\r\n      scientific_consensus: string;\r\n      regulatory_status: string[];\r\n      expert_opinions: string[];\r\n    };\r\n    personalization?: {\r\n      user_goals: string[];\r\n      dietary_restrictions: string[];\r\n      health_conditions: string[];\r\n      personalized_advice: string[];\r\n    };\r\n    metadata?: {\r\n      services_used: string[];\r\n      data_sources: string[];\r\n      confidence_scores: Record<string, number>;\r\n      processing_time: number;\r\n      enhanced_by_ai: boolean;\r\n      api_version: string;\r\n    };\r\n    // Legacy support fields\r\n    service?: string;\r\n    query?: string;\r\n    response?: string;\r\n    session_id?: string;\r\n    conversation_context?: string;\r\n    enhanced?: boolean;\r\n    legacy_recommendations?: string[];\r\n    analysis?: string;\r\n    training_status?: string;\r\n    available_models?: string[];\r\n    sources?: string[];\r\n    [key: string]: any;\r\n  };\r\n  rendering_hints?: {\r\n    primary_display: string;\r\n    chart_components: string[];\r\n    key_metrics: string[];\r\n    action_items: string[];\r\n  };\r\n  service_used: string;\r\n  request_type?: string;\r\n  processing_time?: number;\r\n  suggestions?: string[];\r\n}\r\n\r\n// Type guard for detecting unified responses at runtime\r\nexport function isUnifiedResponse(obj: any): obj is UnifiedResponse {\r\n  return obj && typeof obj === 'object' && ('data' in obj) && ('service_used' in obj);\r\n}\r\n\r\n// Legacy types for backward compatibility\r\nexport interface UserContext {\r\n  age?: number;\r\n  family_size?: number;\r\n  family_history?: string[];\r\n  health_concerns?: string[];\r\n  dietary_restrictions?: string[];\r\n  activity_level?: 'low' | 'moderate' | 'high';\r\n  current_health_concerns?: string[];\r\n}\r\n\r\nexport interface WihyRequest {\r\n  query: string;\r\n  user_context?: UserContext;\r\n}\r\n\r\nexport interface RiskFactor {\r\n  risk_factor: string;\r\n  associated_illnesses: string;\r\n  prevalence_rate: number;\r\n  preventability_score: number;\r\n}\r\n\r\nexport interface ActionItem {\r\n  action: string;\r\n  priority: string;\r\n  target_illness: string;\r\n  evidence_level: string;\r\n  mechanism: string;\r\n  timeline: string;\r\n}\r\n\r\nexport interface PersonalizedAnalysis {\r\n  identified_risk_factors: RiskFactor[];\r\n  priority_health_goals: string[];\r\n  action_items: ActionItem[];\r\n  timeline: string;\r\n}\r\n\r\nexport interface ResearchFoundation {\r\n  citation_text: string;\r\n  study_type: string;\r\n  key_finding: string;\r\n}\r\n\r\nexport interface ProgressTracking {\r\n  key_metrics: string[];\r\n  reassessment_period: string;\r\n}\r\n\r\nexport interface WihyResponseData {\r\n  query_type: string;\r\n  query: string;\r\n  core_principle: string;\r\n  personalized_analysis: PersonalizedAnalysis;\r\n  research_foundation: ResearchFoundation[];\r\n  progress_tracking: ProgressTracking;\r\n  biblical_wisdom: string[];\r\n}\r\n\r\nexport interface WihyResponse {\r\n  success: boolean;\r\n  timestamp: string;\r\n  response_type: string;\r\n  query: string;\r\n  user_context?: UserContext;\r\n  wihy_response: WihyResponseData;\r\n  message: string;\r\n}\r\n\r\nexport interface WihyError {\r\n  detail: string;\r\n}\r\n\r\nclass WihyEnhancedAPIService {\r\n  private baseURL: string;\r\n  private isLocalDevelopment: boolean;\r\n\r\n  constructor() {\r\n    this.baseURL = API_CONFIG.WIHY_API_URL;\r\n    this.isLocalDevelopment = this.baseURL.includes('localhost');\r\n  }\r\n\r\n  /**\r\n   * Ask WiHy Enhanced Model a health-related question (2,325 training examples)\r\n   */\r\n  async askEnhancedHealthQuestion(request: EnhancedHealthQuestion): Promise<EnhancedHealthResponse> {\r\n    try {\r\n      logger.apiRequest('Making WiHy Enhanced Model API request', request);\r\n      \r\n      const endpoint = `${this.baseURL}/ask`;\r\n      \r\n      // Use fetch API with timeout and retry logic\r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\r\n      \r\n      const response = await this.fetchWithRetry(endpoint, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(request),\r\n        signal: controller.signal\r\n      });\r\n\r\n      clearTimeout(timeoutId);\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      logger.apiResponse('WiHy Enhanced Model API response received', data);\r\n      return data;\r\n    } catch (error) {\r\n      logger.error('WiHy Enhanced Model API error:', error);\r\n      throw this.handleEnhancedError(error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Scan food image using enhanced vision analysis\r\n   */\r\n  async scanFoodImage(imageFile: File, context: string = ''): Promise<ImageScanResponse> {\r\n    try {\r\n      const formData = new FormData();\r\n      formData.append('image', imageFile);\r\n      formData.append('context', context);\r\n      \r\n      const endpoint = getApiEndpoint('scan');\r\n      \r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 45000); // 45 second timeout for images\r\n      \r\n      const response = await this.fetchWithRetry(endpoint, {\r\n        method: 'POST',\r\n        body: formData,\r\n        signal: controller.signal\r\n      });\r\n\r\n      clearTimeout(timeoutId);\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      logger.apiResponse('WiHy Image Scanner response received', data);\r\n      return data;\r\n    } catch (error) {\r\n      logger.error('WiHy Image Scanner error:', error);\r\n      throw this.handleScannerError(error, 'image');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Scan barcode using enhanced nutrition database (via /ask endpoint)\r\n   */\r\n  async scanBarcode(barcode: string, context: any = {}): Promise<BarcodeScanResponse> {\r\n    try {\r\n      // Use the /ask endpoint with barcode-specific query format (per integration guide)\r\n      const requestBody = {\r\n        query: `Analyze barcode: ${barcode}`,\r\n        user_context: {\r\n          scan_location: context.scan_location || 'web_app',\r\n          device_type: context.device_type || 'desktop',\r\n          user_type: context.user_type || 'general'\r\n        }\r\n      };\r\n      \r\n      const endpoint = getApiEndpoint('ask'); // Points to /ask endpoint\r\n      \r\n      const controller = new AbortController();\r\n      const timeoutId = setTimeout(() => controller.abort(), 20000); // 20 second timeout\r\n      \r\n      const response = await this.fetchWithRetry(endpoint, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify(requestBody),\r\n        signal: controller.signal\r\n      });\r\n\r\n      clearTimeout(timeoutId);\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n\r\n      const data = await response.json();\r\n      logger.apiResponse('WiHy Barcode Scanner response received', data);\r\n      \r\n      // Process the response to extract NOVA and health data\r\n      return this.processBarcodeScanResponse(data, barcode);\r\n    } catch (error) {\r\n      logger.error('WiHy Barcode Scanner error:', error);\r\n      throw this.handleScannerError(error, 'barcode');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process barcode scan response to extract NOVA and health data (per integration guide)\r\n   */\r\n  private processBarcodeScanResponse(result: any, barcode: string): BarcodeScanResponse {\r\n    const analysis = result.analysis || result;\r\n    const {\r\n      nova_group,\r\n      nova_classification,\r\n      food_quality_score,\r\n      research_quality_score,\r\n      health_verdict,\r\n      addiction_analysis,\r\n      ingredient_analysis\r\n    } = analysis;\r\n\r\n    return {\r\n      success: true,\r\n      nova_group: nova_group || 4,\r\n      health_score: food_quality_score || 0,\r\n      product_name: analysis.product_name || `Product ${barcode}`,\r\n      ingredients: analysis.ingredients || [],\r\n      nutritional_data: {\r\n        calories_per_100g: analysis.calories_per_100g || 0,\r\n        protein_g: analysis.protein_g || 0,\r\n        carbs_g: analysis.carbs_g || 0,\r\n        fat_g: analysis.fat_g || 0,\r\n        fiber_g: analysis.fiber_g || 0,\r\n        sodium_mg: analysis.sodium_mg || 0,\r\n      },\r\n      health_analysis: {\r\n        carcinogen_alerts: addiction_analysis?.addictive_components || [],\r\n        toxic_additives: analysis.toxic_additives || [],\r\n        processing_level: nova_classification || 'Ultra-processed',\r\n      },\r\n      wihy_recommendations: analysis.recommendations || [],\r\n      data_sources: result.research_citations || ['WiHy Enhanced Database', 'OpenFoodFacts']\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Check API health and get status\r\n   */\r\n  async checkAPIHealth(): Promise<{ status: string; model_version: string; training_examples: number }> {\r\n    try {\r\n      const response = await fetch(getApiEndpoint('health'), {\r\n        method: 'GET',\r\n        headers: { 'Accept': 'application/json' }\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Health check failed: ${response.status}`);\r\n      }\r\n\r\n      return await response.json();\r\n    } catch (error) {\r\n      logger.error('WiHy API health check failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Fetch with simple retry logic (single endpoint only)\r\n   */\r\n  private async fetchWithRetry(url: string, options: RequestInit, retries: number = 2): Promise<Response> {\r\n    let lastError: Error;\r\n    \r\n    for (let attempt = 0; attempt <= retries; attempt++) {\r\n      try {\r\n        const response = await fetch(url, options);\r\n        return response; // Return response for error handling upstream\r\n      } catch (error) {\r\n        lastError = error as Error;\r\n        logger.warn(`Attempt ${attempt + 1} failed for ${this.baseURL}:`, error);\r\n        \r\n        // If this is the last attempt, throw error\r\n        if (attempt === retries) {\r\n          throw lastError;\r\n        }\r\n        \r\n        // Wait before retry (exponential backoff)\r\n        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt)));\r\n      }\r\n    }\r\n    \r\n    throw lastError!;\r\n  }\r\n\r\n  /**\r\n   * Enhanced error handling for API responses\r\n   */\r\n  private handleEnhancedError(error: any): Error {\r\n    if (error instanceof Error) {\r\n      // Check for timeout/abort errors\r\n      if (error.name === 'AbortError') {\r\n        return new Error('TIMEOUT_ERROR: Enhanced model request timed out - services may be under heavy load');\r\n      }\r\n      \r\n      // Check for CORS errors\r\n      if (error.message.includes('CORS') || \r\n          error.message.includes('Access to fetch') ||\r\n          error.message.includes('No \\'Access-Control-Allow-Origin\\'')) {\r\n        return new Error('CORS_ERROR: Unable to connect to WiHy Enhanced Model from this domain');\r\n      }\r\n      \r\n      // Check for network/connectivity issues\r\n      if (error.message.includes('fetch') || \r\n          error.message.includes('network') || \r\n          error.name === 'TypeError' ||\r\n          error.message.includes('Failed to fetch')) {\r\n        return new Error('NETWORK_ERROR: Unable to connect to WiHy Enhanced Model services');\r\n      }\r\n      \r\n      // Check for server errors\r\n      if (error.message.includes('HTTP error! status: 5')) {\r\n        return new Error('SERVER_ERROR: WiHy Enhanced Model temporarily unavailable');\r\n      }\r\n      \r\n      return new Error(error.message || 'WiHy Enhanced Model request failed');\r\n    }\r\n    \r\n    return new Error('Unknown error occurred while contacting WiHy Enhanced Model');\r\n  }\r\n\r\n  /**\r\n   * Scanner-specific error handling\r\n   */\r\n  private handleScannerError(error: any, scanType: 'image' | 'barcode'): Error {\r\n    const context = scanType === 'image' ? 'Image Scanner' : 'Barcode Scanner';\r\n    \r\n    if (error instanceof Error) {\r\n      if (error.name === 'AbortError') {\r\n        return new Error(`TIMEOUT_ERROR: ${context} request timed out`);\r\n      }\r\n      \r\n      if (error.message.includes('HTTP error! status: 400')) {\r\n        return new Error(`VALIDATION_ERROR: Invalid ${scanType} format or data`);\r\n      }\r\n      \r\n      if (error.message.includes('HTTP error! status: 404')) {\r\n        return new Error(`NOT_FOUND: ${scanType === 'barcode' ? 'Product not found in nutrition databases' : 'Unable to analyze image'}`);\r\n      }\r\n      \r\n      return new Error(`${context.toUpperCase()}_ERROR: ${error.message}`);\r\n    }\r\n    \r\n    return new Error(`Unknown ${context.toLowerCase()} error occurred`);\r\n  }\r\n\r\n  /**\r\n   * Legacy compatibility method - Ask WiHy a health-related question\r\n   * Now routes to Enhanced Model ONLY (no fallbacks)\r\n   */\r\n  async askAnything(request: WihyRequest | UnifiedRequest): Promise<HealthQuestionResponse | WihyResponse | UnifiedResponse> {\r\n    try {\r\n      // Convert legacy request to enhanced format\r\n      const enhancedRequest: EnhancedHealthQuestion = {\r\n        query: request.query,\r\n        context: 'user_context' in request ? JSON.stringify(request.user_context) : '',\r\n        user_id: 'user_id' in request ? request.user_id : undefined\r\n      };\r\n      \r\n      // Use enhanced model ONLY\r\n      const enhancedResponse = await this.askEnhancedHealthQuestion(enhancedRequest);\r\n      \r\n      // Convert enhanced response to legacy format for backward compatibility\r\n      return this.convertEnhancedToLegacy(enhancedResponse, request.query);\r\n      \r\n    } catch (error) {\r\n      logger.error('Enhanced WiHy API failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Convert Enhanced Model response to legacy format for backward compatibility\r\n   */\r\n  private convertEnhancedToLegacy(enhancedResponse: EnhancedHealthResponse, originalQuery: string): WihyResponse {\r\n    return {\r\n      success: true,\r\n      timestamp: enhancedResponse.timestamp || new Date().toISOString(),\r\n      response_type: 'enhanced_model',\r\n      query: originalQuery,\r\n      wihy_response: {\r\n        query_type: 'enhanced_model',\r\n        query: originalQuery,\r\n        core_principle: enhancedResponse.answer,\r\n        personalized_analysis: {\r\n          identified_risk_factors: [],\r\n          priority_health_goals: [enhancedResponse.answer],\r\n          action_items: enhancedResponse.wihy_wisdom.map((wisdom: string, index: number) => ({\r\n            action: wisdom,\r\n            priority: 'high',\r\n            target_illness: 'general_health',\r\n            evidence_level: 'enhanced_model',\r\n            mechanism: 'biblical_wisdom',\r\n            timeline: 'immediate'\r\n          })),\r\n          timeline: 'immediate'\r\n        },\r\n        research_foundation: enhancedResponse.research_citations.map((citation: string) => ({\r\n          citation_text: citation,\r\n          study_type: 'enhanced_model_research',\r\n          key_finding: citation\r\n        })),\r\n        progress_tracking: {\r\n          key_metrics: ['enhanced_health_understanding'],\r\n          reassessment_period: '1 week'\r\n        },\r\n        biblical_wisdom: enhancedResponse.wihy_wisdom\r\n      },\r\n      message: enhancedResponse.answer\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Convert UnifiedResponse to legacy WihyResponse format for backward compatibility\r\n   */\r\n  private convertToLegacyFormat(unifiedResponse: UnifiedResponse, originalQuery: string): WihyResponse {\r\n    // Handle chat service response\r\n    if (unifiedResponse.service_used === 'chat' && unifiedResponse.data.response) {\r\n      return {\r\n        success: unifiedResponse.success,\r\n        timestamp: new Date().toISOString(),\r\n        response_type: unifiedResponse.request_type,\r\n        query: originalQuery,\r\n        wihy_response: {\r\n          query_type: unifiedResponse.request_type,\r\n          query: originalQuery,\r\n          core_principle: unifiedResponse.data.response,\r\n          personalized_analysis: {\r\n            identified_risk_factors: [],\r\n            priority_health_goals: [unifiedResponse.data.response],\r\n            action_items: [{\r\n              action: unifiedResponse.data.response,\r\n              priority: 'medium',\r\n              target_illness: 'general_health',\r\n              evidence_level: 'ai_generated',\r\n              mechanism: 'chat_response',\r\n              timeline: 'immediate'\r\n            }],\r\n            timeline: 'immediate'\r\n          },\r\n          research_foundation: [{\r\n            citation_text: 'WiHy AI Chat System',\r\n            study_type: 'ai_response',\r\n            key_finding: unifiedResponse.data.response\r\n          }],\r\n          progress_tracking: {\r\n            key_metrics: ['general_health'],\r\n            reassessment_period: '1 week'\r\n          },\r\n          biblical_wisdom: []\r\n        },\r\n        message: unifiedResponse.data.response\r\n      };\r\n    }\r\n\r\n    // Handle other service types (training, nutrition, etc.)\r\n    return {\r\n      success: unifiedResponse.success,\r\n      timestamp: new Date().toISOString(),\r\n      response_type: unifiedResponse.request_type,\r\n      query: originalQuery,\r\n      wihy_response: {\r\n        query_type: unifiedResponse.request_type,\r\n        query: originalQuery,\r\n        core_principle: unifiedResponse.data.analysis || unifiedResponse.data.response || 'Health Information',\r\n        personalized_analysis: {\r\n          identified_risk_factors: [],\r\n          priority_health_goals: [],\r\n          action_items: unifiedResponse.data.recommendations?.immediate_actions?.map((rec: string, index: number) => ({\r\n            action: rec,\r\n            priority: 'medium',\r\n            target_illness: 'general_health',\r\n            evidence_level: 'moderate',\r\n            mechanism: 'lifestyle_modification',\r\n            timeline: 'ongoing'\r\n          })) || unifiedResponse.data.legacy_recommendations?.map((rec: string, index: number) => ({\r\n            action: rec,\r\n            priority: 'medium',\r\n            target_illness: 'general_health',\r\n            evidence_level: 'moderate',\r\n            mechanism: 'lifestyle_modification',\r\n            timeline: 'ongoing'\r\n          })) || [],\r\n          timeline: 'ongoing'\r\n        },\r\n        research_foundation: unifiedResponse.data.sources?.map((source: string) => ({\r\n          citation_text: source,\r\n          study_type: 'research',\r\n          key_finding: source\r\n        })) || [],\r\n        progress_tracking: {\r\n          key_metrics: ['general_health'],\r\n          reassessment_period: '1 month'\r\n        },\r\n        biblical_wisdom: []\r\n      },\r\n      message: unifiedResponse.data.response || unifiedResponse.data.analysis || 'Health information provided'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get health news articles using the unified API\r\n   */\r\n  async getHealthNews(categories?: string[], limit?: number): Promise<WihyResponse> {\r\n    const query = categories && categories.length > 0 \r\n      ? `Latest health news about ${categories.join(', ')}`\r\n      : 'Latest health news';\r\n    \r\n    const request: UnifiedRequest = {\r\n      query: query,\r\n      request_type: 'health',\r\n      context: {\r\n        categories: categories,\r\n        limit: limit\r\n      }\r\n    };\r\n\r\n    const response = await this.askAnything(request);\r\n    if ('data' in response) {\r\n      // It's a UnifiedResponse, convert to legacy format\r\n      return this.convertToLegacyFormat(response as UnifiedResponse, query);\r\n    }\r\n    return response as WihyResponse;\r\n  }\r\n\r\n  /**\r\n   * Search for nutrition information using the unified API\r\n   */\r\n  async searchNutrition(foodQuery: string, userContext?: UserContext): Promise<WihyResponse> {\r\n    const request: UnifiedRequest = {\r\n      query: `Nutrition information for ${foodQuery}`,\r\n      request_type: 'nutrition',\r\n      context: userContext || {}\r\n    };\r\n\r\n    const response = await this.askAnything(request);\r\n    if ('data' in response) {\r\n      // It's a UnifiedResponse, convert to legacy format\r\n      return this.convertToLegacyFormat(response as UnifiedResponse, request.query);\r\n    }\r\n    return response as WihyResponse;\r\n  }\r\n\r\n  /**\r\n   * Legacy scan food images method - now uses enhanced scanner\r\n   */\r\n  async scanFood(file?: File, scanOptions?: Partial<ScanRequest>): Promise<WihyResponse | UnifiedResponse> {\r\n    try {\r\n      if (file) {\r\n        // Use enhanced image scanner\r\n        const enhancedResponse = await this.scanFoodImage(file, scanOptions?.user_context ? JSON.stringify(scanOptions.user_context) : '');\r\n        \r\n        // Convert to legacy format\r\n        return this.convertImageScanToLegacy(enhancedResponse, 'Image scan analysis');\r\n        \r\n      } else if (scanOptions?.barcode) {\r\n        // Use enhanced barcode scanner\r\n        const enhancedResponse = await this.scanBarcode(scanOptions.barcode, scanOptions.user_context);\r\n        \r\n        // Convert to legacy format\r\n        return this.convertBarcodeScanToLegacy(enhancedResponse, `Barcode scan: ${scanOptions.barcode}`);\r\n        \r\n      } else {\r\n        throw new Error('No file or barcode provided for scanning');\r\n      }\r\n      \r\n    } catch (error) {\r\n      logger.error('WiHy Scan error:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Convert Image Scanner response to legacy format\r\n   */\r\n  private convertImageScanToLegacy(response: ImageScanResponse, query: string): WihyResponse {\r\n    const recommendations = response.wihy_recommendations || [];\r\n    const warnings = response.carcinogen_warnings || [];\r\n    \r\n    return {\r\n      success: response.success,\r\n      timestamp: new Date().toISOString(),\r\n      response_type: 'image_scan',\r\n      query: query,\r\n      wihy_response: {\r\n        query_type: 'image_scan',\r\n        query: query,\r\n        core_principle: response.overall_assessment?.verdict || 'Image analysis complete',\r\n        personalized_analysis: {\r\n          identified_risk_factors: warnings.map(warning => ({\r\n            risk_factor: warning,\r\n            associated_illnesses: 'various',\r\n            prevalence_rate: 0,\r\n            preventability_score: 100\r\n          })),\r\n          priority_health_goals: recommendations,\r\n          action_items: recommendations.map(rec => ({\r\n            action: rec,\r\n            priority: 'high',\r\n            target_illness: 'general_health',\r\n            evidence_level: 'image_analysis',\r\n            mechanism: 'food_choice',\r\n            timeline: 'immediate'\r\n          })),\r\n          timeline: 'immediate'\r\n        },\r\n        research_foundation: response.data_sources?.map(source => ({\r\n          citation_text: source,\r\n          study_type: 'database',\r\n          key_finding: source\r\n        })) || [],\r\n        progress_tracking: {\r\n          key_metrics: ['food_quality_awareness'],\r\n          reassessment_period: '1 week'\r\n        },\r\n        biblical_wisdom: ['Choose foods that nourish your temple - 1 Corinthians 6:19']\r\n      },\r\n      message: this.formatImageScanResponse(response)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Convert Barcode Scanner response to legacy format\r\n   */\r\n  private convertBarcodeScanToLegacy(response: BarcodeScanResponse, query: string): WihyResponse {\r\n    const recommendations = response.wihy_recommendations || [];\r\n    const warnings = [...(response.health_analysis?.carcinogen_alerts || []), ...(response.health_analysis?.toxic_additives || [])];\r\n    \r\n    return {\r\n      success: response.success,\r\n      timestamp: new Date().toISOString(),\r\n      response_type: 'barcode_scan',\r\n      query: query,\r\n      wihy_response: {\r\n        query_type: 'barcode_scan',\r\n        query: query,\r\n        core_principle: `Product Analysis: ${response.product_name}`,\r\n        personalized_analysis: {\r\n          identified_risk_factors: warnings.map(warning => ({\r\n            risk_factor: warning,\r\n            associated_illnesses: 'various',\r\n            prevalence_rate: 0,\r\n            preventability_score: 100\r\n          })),\r\n          priority_health_goals: recommendations,\r\n          action_items: recommendations.map(rec => ({\r\n            action: rec,\r\n            priority: 'high',\r\n            target_illness: 'general_health',\r\n            evidence_level: 'product_analysis',\r\n            mechanism: 'ingredient_awareness',\r\n            timeline: 'immediate'\r\n          })),\r\n          timeline: 'immediate'\r\n        },\r\n        research_foundation: response.data_sources?.map(source => ({\r\n          citation_text: source,\r\n          study_type: 'nutrition_database',\r\n          key_finding: source\r\n        })) || [],\r\n        progress_tracking: {\r\n          key_metrics: ['product_awareness', 'nova_understanding'],\r\n          reassessment_period: '1 week'\r\n        },\r\n        biblical_wisdom: ['Real food doesn\\'t need complicated analysis - choose whole foods']\r\n      },\r\n      message: this.formatBarcodeScanResponse(response)\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Convert File to base64 string\r\n   */\r\n  private fileToBase64(file: File): Promise<string> {\r\n    return new Promise((resolve, reject) => {\r\n      const reader = new FileReader();\r\n      reader.readAsDataURL(file);\r\n      reader.onload = () => {\r\n        const result = reader.result as string;\r\n        // Remove the data:image/jpeg;base64, prefix\r\n        const base64 = result.split(',')[1];\r\n        resolve(base64);\r\n      };\r\n      reader.onerror = error => reject(error);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * General health search using the unified API (single call only)\r\n   */\r\n  async searchHealth(query: string, userContext?: UserContext): Promise<WihyResponse | UnifiedResponse> {\r\n    const timestamp = new Date().toISOString();\r\n    const callId = Math.random().toString(36).substr(2, 9);\r\n    \r\n    logger.info(`🔍 [${callId}] WiHy searchHealth called at ${timestamp}`, { \r\n      query, \r\n      userContext,\r\n      stack: new Error().stack?.split('\\n').slice(1, 4).map(line => line.trim())\r\n    });\r\n    \r\n    const request: UnifiedRequest = {\r\n      query: query,\r\n      request_type: 'auto',\r\n      context: userContext || {}\r\n    };\r\n\r\n    const response = await this.askAnything(request);\r\n    \r\n    logger.info(`✅ [${callId}] WiHy searchHealth completed at ${new Date().toISOString()}`, { \r\n      query, \r\n      responseType: response.constructor.name,\r\n      success: (response as any).success,\r\n      duration: `${Date.now() - new Date(timestamp).getTime()}ms`\r\n    });\r\n    \r\n    // Return the raw response (could be legacy WihyResponse or UnifiedResponse)\r\n    return response as WihyResponse | UnifiedResponse;\r\n  }\r\n\r\n  /**\r\n   * Get NOVA classification guidance (per integration guide)\r\n   */\r\n  getNovaGuidance(novaGroup: number): { action: string; color: string; message: string } {\r\n    const guidance = {\r\n      1: { action: 'CHOOSE', color: 'green', message: 'Real food as God intended' },\r\n      2: { action: 'MODERATE', color: 'yellow', message: 'Use sparingly' },\r\n      3: { action: 'LIMIT', color: 'orange', message: 'Find alternatives' },\r\n      4: { action: 'AVOID', color: 'red', message: 'Your family deserves better' }\r\n    };\r\n    \r\n    return guidance[novaGroup as keyof typeof guidance] || guidance[4];\r\n  }\r\n\r\n  /**\r\n   * Process WiHy response following integration guide patterns\r\n   */\r\n  processWihyResponse(result: any): ProcessedScanResult {\r\n    const analysis = result.analysis || result;\r\n    const {\r\n      nova_group,\r\n      nova_classification,\r\n      food_quality_score,\r\n      research_quality_score,\r\n      health_verdict,\r\n      addiction_analysis,\r\n      recommendations\r\n    } = analysis;\r\n\r\n    const novaGroup = nova_group || 4;\r\n    const guidance = this.getNovaGuidance(novaGroup);\r\n\r\n    return {\r\n      isHealthy: novaGroup <= 2 && (food_quality_score || 0) >= 60,\r\n      novaGroup: novaGroup,\r\n      healthScore: food_quality_score || 0,\r\n      researchQuality: research_quality_score || 0,\r\n      verdict: health_verdict || 'Unknown',\r\n      addictionScore: addiction_analysis?.addiction_score || 0,\r\n      recommendations: recommendations || [],\r\n      warnings: addiction_analysis?.addictive_components || [],\r\n      familySafe: (food_quality_score || 0) >= 60,\r\n      colorCode: guidance.color as 'green' | 'yellow' | 'orange' | 'red',\r\n      rawResponse: result\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Format Enhanced Model response for display in the UI\r\n   */\r\n  formatEnhancedResponse(response: EnhancedHealthResponse): string {\r\n    let formatted = `# WiHy Enhanced Health Intelligence\\n\\n`;\r\n    \r\n    // Main response content\r\n    formatted += response.answer;\r\n    \r\n    // Add research citations if available\r\n    if (response.research_citations && response.research_citations.length > 0) {\r\n      formatted += `\\n\\n## 📚 Research Citations\\n`;\r\n      response.research_citations.forEach((citation, index) => {\r\n        formatted += `${index + 1}. ${citation}\\n`;\r\n      });\r\n    }\r\n    \r\n    // Add biblical wisdom if available\r\n    if (response.wihy_wisdom && response.wihy_wisdom.length > 0) {\r\n      formatted += `\\n\\n## ✝️ Biblical Wisdom\\n`;\r\n      response.wihy_wisdom.forEach(wisdom => {\r\n        formatted += `> ${wisdom}\\n\\n`;\r\n      });\r\n    }\r\n    \r\n    // Add enhanced model info\r\n    formatted += `\\n\\n---\\n\\n`;\r\n    formatted += `*Enhanced Model Response (${response.training_examples_used} training examples)*\\n`;\r\n    formatted += `*Confidence Score: ${Math.round(response.confidence_score * 100)}%*\\n`;\r\n    formatted += `*Model Version: ${response.model_version}*`;\r\n    \r\n    return formatted;\r\n  }\r\n\r\n  /**\r\n   * Format Image Scanner response for display\r\n   */\r\n  formatImageScanResponse(response: ImageScanResponse): string {\r\n    let formatted = `# 📷 WiHy Image Analysis Results\\n\\n`;\r\n    \r\n    if (response.success && response.overall_assessment) {\r\n      const { health_score, verdict, nova_group } = response.overall_assessment;\r\n      const guidance = response.nova_chart_reference?.client_guidance;\r\n      \r\n      formatted += `## Health Assessment\\n`;\r\n      formatted += `**Health Score:** ${health_score}/100\\n`;\r\n      formatted += `**Verdict:** ${verdict}\\n`;\r\n      formatted += `**NOVA Group:** ${nova_group} (${this.getNovaLabel(nova_group)})\\n`;\r\n      \r\n      if (guidance) {\r\n        formatted += `**Recommendation:** ${guidance.action} - ${guidance.message}\\n\\n`;\r\n      }\r\n      \r\n      // Detected foods\r\n      if (response.detected_foods && response.detected_foods.length > 0) {\r\n        formatted += `## 🍽️ Detected Foods\\n`;\r\n        response.detected_foods.forEach(food => {\r\n          formatted += `- **${food.name}** (Confidence: ${Math.round(food.confidence * 100)}%, NOVA: ${food.nova_group})\\n`;\r\n        });\r\n        formatted += '\\n';\r\n      }\r\n      \r\n      // WIHY recommendations\r\n      if (response.wihy_recommendations && response.wihy_recommendations.length > 0) {\r\n        formatted += `## 💡 WIHY Recommendations\\n`;\r\n        response.wihy_recommendations.forEach(rec => {\r\n          formatted += `- ${rec}\\n`;\r\n        });\r\n        formatted += '\\n';\r\n      }\r\n      \r\n      // Health warnings\r\n      if (response.carcinogen_warnings && response.carcinogen_warnings.length > 0) {\r\n        formatted += `## ⚠️ Health Warnings\\n`;\r\n        response.carcinogen_warnings.forEach(warning => {\r\n          formatted += `- ${warning}\\n`;\r\n        });\r\n        formatted += '\\n';\r\n      }\r\n      \r\n      // Family safety\r\n      if (response.family_safety) {\r\n        formatted += `## 👨‍👩‍👧‍👦 Family Safety\\n`;\r\n        formatted += `**Status:** ${response.family_safety.family_safe ? '✅ Safe' : '❌ Not Recommended'}\\n`;\r\n        formatted += `**Verdict:** ${response.family_safety.family_verdict}\\n\\n`;\r\n      }\r\n      \r\n    } else {\r\n      formatted += `Analysis failed. Please try again or choose whole foods when in doubt.\\n\\n`;\r\n    }\r\n    \r\n    // Data sources\r\n    if (response.data_sources && response.data_sources.length > 0) {\r\n      formatted += `---\\n\\n*Data sources: ${response.data_sources.join(', ')}*`;\r\n    }\r\n    \r\n    return formatted;\r\n  }\r\n\r\n  /**\r\n   * Format Barcode Scanner response for display\r\n   */\r\n  formatBarcodeScanResponse(response: BarcodeScanResponse): string {\r\n    let formatted = `# 🔍 WiHy Barcode Analysis\\n\\n`;\r\n    \r\n    if (response.success) {\r\n      formatted += `## Product Information\\n`;\r\n      formatted += `**Product:** ${response.product_name}\\n`;\r\n      formatted += `**Health Score:** ${response.health_score}/100\\n`;\r\n      formatted += `**NOVA Group:** ${response.nova_group} (${this.getNovaLabel(response.nova_group)})\\n\\n`;\r\n      \r\n      // Nutritional data\r\n      if (response.nutritional_data) {\r\n        const nutrition = response.nutritional_data;\r\n        formatted += `## 📊 Nutrition Facts (per 100g)\\n`;\r\n        formatted += `- **Calories:** ${nutrition.calories_per_100g}\\n`;\r\n        formatted += `- **Protein:** ${nutrition.protein_g}g\\n`;\r\n        formatted += `- **Carbohydrates:** ${nutrition.carbs_g}g\\n`;\r\n        formatted += `- **Fat:** ${nutrition.fat_g}g\\n`;\r\n        formatted += `- **Fiber:** ${nutrition.fiber_g}g\\n`;\r\n        formatted += `- **Sodium:** ${nutrition.sodium_mg}mg\\n\\n`;\r\n      }\r\n      \r\n      // Health analysis\r\n      if (response.health_analysis) {\r\n        const analysis = response.health_analysis;\r\n        formatted += `## 🔬 Health Analysis\\n`;\r\n        formatted += `**Processing Level:** ${analysis.processing_level}\\n`;\r\n        \r\n        if (analysis.carcinogen_alerts && analysis.carcinogen_alerts.length > 0) {\r\n          formatted += `**⚠️ Carcinogen Alerts:**\\n`;\r\n          analysis.carcinogen_alerts.forEach(alert => {\r\n            formatted += `- ${alert}\\n`;\r\n          });\r\n        }\r\n        \r\n        if (analysis.toxic_additives && analysis.toxic_additives.length > 0) {\r\n          formatted += `**🧪 Toxic Additives:**\\n`;\r\n          analysis.toxic_additives.forEach(additive => {\r\n            formatted += `- ${additive}\\n`;\r\n          });\r\n        }\r\n        formatted += '\\n';\r\n      }\r\n      \r\n      // WIHY recommendations\r\n      if (response.wihy_recommendations && response.wihy_recommendations.length > 0) {\r\n        formatted += `## 💡 WIHY Recommendations\\n`;\r\n        response.wihy_recommendations.forEach(rec => {\r\n          formatted += `- ${rec}\\n`;\r\n        });\r\n        formatted += '\\n';\r\n      }\r\n      \r\n      // Ingredients\r\n      if (response.ingredients && response.ingredients.length > 0) {\r\n        formatted += `## 🧾 Ingredients\\n`;\r\n        formatted += response.ingredients.join(', ') + '\\n\\n';\r\n      }\r\n      \r\n    } else {\r\n      formatted += `Product not found or analysis failed. Choose foods with 5 or fewer ingredients when in doubt.\\n\\n`;\r\n    }\r\n    \r\n    // Data sources\r\n    if (response.data_sources && response.data_sources.length > 0) {\r\n      formatted += `---\\n\\n*Data sources: ${response.data_sources.join(', ')}*`;\r\n    }\r\n    \r\n    return formatted;\r\n  }\r\n\r\n  /**\r\n   * Get NOVA group label\r\n   */\r\n  private getNovaLabel(novaGroup: number): string {\r\n    const labels = {\r\n      1: 'Natural/Unprocessed',\r\n      2: 'Processed Culinary Ingredients', \r\n      3: 'Processed Foods',\r\n      4: 'Ultra-Processed Foods'\r\n    };\r\n    return labels[novaGroup as keyof typeof labels] || 'Unknown';\r\n  }\r\n\r\n  /**\r\n   * Format WiHy Response in user-friendly format for display\r\n   */\r\n  formatWihyResponse(response: HealthQuestionResponse | WihyResponse | UnifiedResponse): string {\r\n    // Handle new HealthQuestionResponse format (OpenAPI v4.0.0)\r\n    if ('success' in response && 'data' in response && response.data && 'response' in response.data && 'processor_used' in response.data) {\r\n      const healthResp = response as HealthQuestionResponse;\r\n      const data = healthResp.data;\r\n      \r\n      let formatted = `# WiHy Health Intelligence\\n\\n`;\r\n      \r\n      // Main response content\r\n      formatted += data.response;\r\n      \r\n      // Add health insights if available\r\n      if (data.health_insights) {\r\n        if (data.health_insights.key_benefits?.length) {\r\n          formatted += `\\n\\n## 🌟 Key Benefits\\n`;\r\n          data.health_insights.key_benefits.forEach(benefit => {\r\n            formatted += `- ${benefit}\\n`;\r\n          });\r\n        }\r\n        \r\n        if (data.health_insights.potential_risks?.length) {\r\n          formatted += `\\n\\n## ⚠️ Potential Risks\\n`;\r\n          data.health_insights.potential_risks.forEach(risk => {\r\n            formatted += `- ${risk}\\n`;\r\n          });\r\n        }\r\n        \r\n        if (data.health_insights.recommendations?.length) {\r\n          formatted += `\\n\\n## 📋 Recommendations\\n`;\r\n          data.health_insights.recommendations.forEach(rec => {\r\n            formatted += `- ${rec}\\n`;\r\n          });\r\n        }\r\n      }\r\n      \r\n      // Add processing info\r\n      formatted += `\\n\\n---\\n\\n*Processed by ${data.processor_used} in ${data.processing_time.toFixed(2)}ms*`;\r\n      \r\n      return formatted;\r\n    }\r\n    \r\n    // Handle UnifiedResponse format (legacy API)\r\n    if ('success' in response && 'data' in response && response.data && 'ai_response' in response.data) {\r\n      const unifiedResp = response as UnifiedResponse;\r\n      \r\n      let formatted = `# WiHy Health Assistant\\n\\n`;\r\n      \r\n      // Use the ai_response.response field which contains the actual response\r\n      if (unifiedResp.data.ai_response && unifiedResp.data.ai_response.response) {\r\n        formatted += unifiedResp.data.ai_response.response;\r\n      } else {\r\n        // Fallback to showing raw data if ai_response is not available\r\n        formatted += `**Data:**\\n\\`\\`\\`json\\n${JSON.stringify(unifiedResp.data, null, 2)}\\n\\`\\`\\``;\r\n      }\r\n      \r\n      // Add service information if available\r\n      if (unifiedResp.data.ai_response?.service) {\r\n        formatted += `\\n\\n---\\n\\n*Response from ${unifiedResp.data.ai_response.service} service*`;\r\n        if (unifiedResp.data.ai_response.confidence) {\r\n          formatted += ` (Confidence: ${Math.round(unifiedResp.data.ai_response.confidence * 100)}%)`;\r\n        }\r\n      }\r\n      \r\n      return formatted;\r\n    }\r\n    \r\n    // Handle legacy WihyResponse format\r\n    const legacyResp = response as WihyResponse;\r\n    const { wihy_response } = legacyResp;\r\n    \r\n    let formatted = `# ${wihy_response.core_principle}\\n\\n`;\r\n    \r\n    // Personalized Analysis\r\n    if (wihy_response.personalized_analysis) {\r\n      formatted += `## 🎯 Personalized Health Analysis\\n\\n`;\r\n      \r\n      // Risk Factors\r\n      if (wihy_response.personalized_analysis.identified_risk_factors?.length > 0) {\r\n        formatted += `### Identified Risk Factors:\\n`;\r\n        wihy_response.personalized_analysis.identified_risk_factors.forEach(risk => {\r\n          formatted += `- **${risk.risk_factor.replace(/_/g, ' ').toUpperCase()}**\\n`;\r\n          formatted += `  - Associated with: ${risk.associated_illnesses.replace(/_/g, ' ')}\\n`;\r\n          formatted += `  - Prevalence: ${risk.prevalence_rate}%\\n`;\r\n          formatted += `  - Preventability: ${risk.preventability_score}%\\n\\n`;\r\n        });\r\n      }\r\n      \r\n      // Priority Goals\r\n      if (wihy_response.personalized_analysis.priority_health_goals?.length > 0) {\r\n        formatted += `### 🎯 Priority Health Goals:\\n`;\r\n        wihy_response.personalized_analysis.priority_health_goals.forEach(goal => {\r\n          formatted += `- ${goal}\\n`;\r\n        });\r\n        formatted += '\\n';\r\n      }\r\n      \r\n      // Action Items\r\n      if (wihy_response.personalized_analysis.action_items?.length > 0) {\r\n        formatted += `### 📋 Action Items:\\n`;\r\n        wihy_response.personalized_analysis.action_items.forEach((action, index) => {\r\n          formatted += `#### ${index + 1}. ${action.action}\\n`;\r\n          formatted += `- **Priority:** ${action.priority}\\n`;\r\n          formatted += `- **Target:** ${action.target_illness.replace(/_/g, ' ')}\\n`;\r\n          formatted += `- **Evidence Level:** ${action.evidence_level}\\n`;\r\n          formatted += `- **How it works:** ${action.mechanism}\\n`;\r\n          formatted += `- **Timeline:** ${action.timeline}\\n\\n`;\r\n        });\r\n      }\r\n      \r\n      // Timeline\r\n      if (wihy_response.personalized_analysis.timeline) {\r\n        formatted += `**Implementation Timeline:** ${wihy_response.personalized_analysis.timeline}\\n\\n`;\r\n      }\r\n    }\r\n    \r\n    // Research Foundation\r\n    if (wihy_response.research_foundation?.length > 0) {\r\n      formatted += `## 📚 Research Foundation\\n\\n`;\r\n      wihy_response.research_foundation.forEach(research => {\r\n        formatted += `- **${research.citation_text}** (${research.study_type})\\n`;\r\n        formatted += `  ${research.key_finding}\\n\\n`;\r\n      });\r\n    }\r\n    \r\n    // Progress Tracking\r\n    if (wihy_response.progress_tracking) {\r\n      formatted += `## 📊 Progress Tracking\\n\\n`;\r\n      formatted += `**Key Metrics to Track:**\\n`;\r\n      wihy_response.progress_tracking.key_metrics.forEach(metric => {\r\n        formatted += `- ${metric}\\n`;\r\n      });\r\n      formatted += `\\n**Reassessment:** ${wihy_response.progress_tracking.reassessment_period}\\n\\n`;\r\n    }\r\n    \r\n    // Biblical Wisdom\r\n    if (wihy_response.biblical_wisdom?.length > 0) {\r\n      formatted += `## ✝️ Biblical Wisdom\\n\\n`;\r\n      wihy_response.biblical_wisdom.forEach(wisdom => {\r\n        formatted += `> ${wisdom}\\n\\n`;\r\n      });\r\n    }\r\n    \r\n    // Add timestamp if available (different field names in different response formats)\r\n    const timestamp = (response as any).timestamp || (response as any).created_at || new Date().toISOString();\r\n    formatted += `---\\n\\n*WiHy health truth analysis generated at: ${new Date(timestamp).toLocaleString()}*\\n`;\r\n    \r\n    return formatted;\r\n  }\r\n\r\n  /**\r\n   * Extract recommendations from WiHy response for UI display\r\n   */\r\n  extractRecommendations(response: HealthQuestionResponse | WihyResponse | UnifiedResponse): string[] {\r\n    const recommendations: string[] = [];\r\n\r\n    // Handle new HealthQuestionResponse format (OpenAPI v4.0.0)\r\n    if ('success' in response && 'data' in response && response.data && 'health_insights' in response.data) {\r\n      const healthResp = response as HealthQuestionResponse;\r\n      if (healthResp.data.health_insights.recommendations) {\r\n        healthResp.data.health_insights.recommendations.forEach(r => recommendations.push(r));\r\n      }\r\n      return recommendations;\r\n    }\r\n\r\n    if (isUnifiedResponse(response)) {\r\n      // Handle new structured recommendations\r\n      if (response.data.recommendations) {\r\n        const recs = response.data.recommendations;\r\n        if (recs.immediate_actions) recs.immediate_actions.forEach(r => recommendations.push(r));\r\n        if (recs.lifestyle_changes) recs.lifestyle_changes.forEach(r => recommendations.push(r));\r\n        if (recs.better_alternatives) recs.better_alternatives.forEach(r => recommendations.push(r));\r\n        if (recs.shopping_tips) recs.shopping_tips.forEach(r => recommendations.push(r));\r\n        if (recs.meal_planning) recs.meal_planning.forEach(r => recommendations.push(r));\r\n      }\r\n      // Handle legacy recommendations\r\n      if (response.data.legacy_recommendations && response.data.legacy_recommendations.length > 0) {\r\n        response.data.legacy_recommendations.forEach((r: string) => recommendations.push(r));\r\n      }\r\n    } else {\r\n      // Handle legacy WihyResponse format\r\n      const legacyResp = response as WihyResponse;\r\n      if (legacyResp.wihy_response.personalized_analysis?.action_items) {\r\n        legacyResp.wihy_response.personalized_analysis.action_items.forEach(action => {\r\n          recommendations.push(`${action.action} (${action.priority} priority)`);\r\n        });\r\n      }\r\n    }\r\n\r\n    return recommendations;\r\n  }\r\n\r\n  /**\r\n   * Extract citations from WiHy response for UI display\r\n   */\r\n  extractCitations(response: HealthQuestionResponse | WihyResponse | UnifiedResponse): string[] {\r\n    const citations: string[] = [];\r\n\r\n    // Handle new HealthQuestionResponse format (OpenAPI v4.0.0)\r\n    if ('success' in response && 'data' in response && response.data && 'processor_used' in response.data) {\r\n      // For now, the new API doesn't include specific citation fields in the schema\r\n      // We could parse citations from the response text if needed\r\n      return citations;\r\n    }\r\n\r\n    if (isUnifiedResponse(response)) {\r\n      // Unified API may include sources array\r\n      if (response.data.sources && response.data.sources.length > 0) {\r\n        response.data.sources.forEach((s: string) => citations.push(s));\r\n      }\r\n    } else {\r\n      // Handle legacy WihyResponse format\r\n      const legacyResp = response as WihyResponse;\r\n      if (legacyResp.wihy_response.research_foundation) {\r\n        legacyResp.wihy_response.research_foundation.forEach(research => {\r\n          citations.push(`${research.citation_text}: ${research.key_finding}`);\r\n        });\r\n      }\r\n    }\r\n\r\n    return citations;\r\n  }\r\n\r\n  /**\r\n   * Format UnifiedResponse for chat display (simple format)\r\n   */\r\n  formatUnifiedResponseForChat(response: UnifiedResponse): string {\r\n    // Handle chat service responses\r\n    if (response.service_used === 'chat' && response.data.response) {\r\n      // For now, the API is returning very brief responses like \"AI Chat response to: what is healthy\"\r\n      // We should provide more helpful information to the user\r\n      const briefResponse = response.data.response;\r\n      \r\n      if (briefResponse.includes('AI Chat response to:')) {\r\n        // The API gave us a placeholder response, provide something more useful\r\n        const query = response.data.query || 'your question';\r\n        return `I received your question about \"${query}\" and I'm here to help! \r\n\r\nThe WiHy AI system is currently processing health-related queries. While the response system is being optimized, I can help you with:\r\n\r\n• Understanding health and nutrition concepts\r\n• Providing general wellness guidance  \r\n• Explaining health data and metrics\r\n• Offering evidence-based health insights\r\n\r\nWhat specific aspect of health would you like to explore further?`;\r\n      }\r\n      \r\n      return briefResponse;\r\n    }\r\n    \r\n    // Handle other response types\r\n    if (response.data.response) {\r\n      return response.data.response;\r\n    }\r\n    \r\n    if (response.data.analysis) {\r\n      return response.data.analysis;\r\n    }\r\n    \r\n    if (response.data.training_status) {\r\n      let message = `🔄 ${response.data.training_status}`;\r\n      if (response.data.available_models && response.data.available_models.length > 0) {\r\n        message += `\\n\\n📊 Available models: ${response.data.available_models.join(', ')}`;\r\n      }\r\n      return message;\r\n    }\r\n    \r\n    // Fallback - show the raw data in a readable format\r\n    return `I received a response from the ${response.service_used} service. Here's what I found:\\n\\n${JSON.stringify(response.data, null, 2)}`;\r\n  }\r\n}\r\n\r\n// Export a singleton instance of the enhanced API service\r\nexport const wihyAPI = new WihyEnhancedAPIService();\r\n\r\n// ==================== NEW WIHY API v3.0.0 SERVICE ====================\r\n\r\nexport class WihyAPIService {\r\n  private apiKey: string;\r\n  private baseUrl: string;\r\n\r\n  constructor() {\r\n    this.apiKey = process.env.REACT_APP_WIHY_API_KEY || '';\r\n    this.baseUrl = API_CONFIG.WIHY_API_URL;\r\n  }\r\n\r\n  // Health check endpoint\r\n  async healthCheck(): Promise<{ status: string; timestamp: string }> {\r\n    try {\r\n      const response = await fetch(getApiEndpoint('health'), {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${this.apiKey}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      return await response.json();\r\n    } catch (error) {\r\n      logger.error('WIHY health check failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Ask endpoint - general health questions\r\n  async ask(request: WiHyAskRequest): Promise<AskResponse> {\r\n    try {\r\n      const response = await fetch(getApiEndpoint('ask'), {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${this.apiKey}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(request),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      const data: WiHyApiResponse = await response.json();\r\n      return data.response as AskResponse;\r\n    } catch (error) {\r\n      logger.error('WIHY ask request failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Scan endpoint - product/barcode scanning\r\n  async scan(request: WiHyScanRequest): Promise<ScanResponse> {\r\n    try {\r\n      const response = await fetch(getApiEndpoint('scan'), {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${this.apiKey}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(request),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      const data: WiHyApiResponse = await response.json();\r\n      return data.response as ScanResponse;\r\n    } catch (error) {\r\n      logger.error('WIHY scan request failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Chat endpoint - conversational health coaching\r\n  async chat(request: WiHyChatRequest): Promise<ChatResponse> {\r\n    try {\r\n      const response = await fetch(getApiEndpoint('chat'), {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${this.apiKey}`,\r\n          'Content-Type': 'application/json',\r\n        },\r\n        body: JSON.stringify(request),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      const data: WiHyApiResponse = await response.json();\r\n      return data.response as ChatResponse;\r\n    } catch (error) {\r\n      logger.error('WIHY chat request failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Legacy compatibility methods for existing code integration\r\n  async scanBarcode(barcode: string, options?: { enhanced?: boolean }): Promise<any> {\r\n    try {\r\n      const scanRequest: WiHyScanRequest = {\r\n        barcode,\r\n        user_context: {\r\n          include_charts: true,\r\n          include_ingredients: true,\r\n          enhanced_analysis: options?.enhanced || false,\r\n        },\r\n      };\r\n\r\n      const scanResponse = await this.scan(scanRequest);\r\n      \r\n      // Convert new response format to legacy format for compatibility\r\n      return {\r\n        productName: scanResponse.detailed_analysis.scan_metadata?.product_name,\r\n        ingredients: scanResponse.detailed_analysis.ingredients_analysis?.map(ing => ing.ingredient),\r\n        nutritionInfo: this.extractNutritionInfo(scanResponse),\r\n        healthScore: scanResponse.confidence_score,\r\n        alerts: scanResponse.detailed_analysis.health_risks || [],\r\n        recommendations: scanResponse.recommendations,\r\n        barcode: scanResponse.detailed_analysis.scan_metadata?.barcode,\r\n        brand: scanResponse.detailed_analysis.scan_metadata?.brand,\r\n        categories: scanResponse.detailed_analysis.scan_metadata?.categories,\r\n        confidence_score: scanResponse.confidence_score,\r\n      };\r\n    } catch (error) {\r\n      logger.error('Legacy barcode scan failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async scanImage(imageBase64: string, options?: { enhanced?: boolean }): Promise<any> {\r\n    try {\r\n      const scanRequest: WiHyScanRequest = {\r\n        image: imageBase64,\r\n        user_context: {\r\n          include_charts: true,\r\n          include_ingredients: true,\r\n          enhanced_analysis: options?.enhanced || false,\r\n        },\r\n      };\r\n\r\n      const scanResponse = await this.scan(scanRequest);\r\n      \r\n      // Convert new response format to legacy format for compatibility\r\n      return {\r\n        productName: scanResponse.detailed_analysis.scan_metadata?.product_name,\r\n        ingredients: scanResponse.detailed_analysis.ingredients_analysis?.map(ing => ing.ingredient),\r\n        nutritionInfo: this.extractNutritionInfo(scanResponse),\r\n        healthScore: scanResponse.confidence_score,\r\n        alerts: scanResponse.detailed_analysis.health_risks || [],\r\n        recommendations: scanResponse.recommendations,\r\n        confidence_score: scanResponse.confidence_score,\r\n      };\r\n    } catch (error) {\r\n      logger.error('Legacy image scan failed:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private extractNutritionInfo(scanResponse: ScanResponse): any {\r\n    // Extract nutrition info from charts if available\r\n    const nutritionChart = scanResponse.charts.ingredient_health_impact;\r\n    if (!nutritionChart) return undefined;\r\n\r\n    // This is a simplified extraction - in practice, you might need more complex parsing\r\n    // based on the actual chart data structure\r\n    return {\r\n      // These would need to be extracted from the chart data or metadata\r\n      // For now, returning undefined as the exact mapping depends on chart structure\r\n      calories: undefined,\r\n      protein: undefined,\r\n      carbs: undefined,\r\n      fat: undefined,\r\n      sugar: undefined,\r\n      sodium: undefined,\r\n      fiber: undefined,\r\n    };\r\n  }\r\n}\r\n\r\n// Export new API service instance\r\nexport const wihyAPIv3 = new WihyAPIService();\r\n\r\nexport default wihyAPI;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}