{"ast":null,"code":"// Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT License. See License.txt in the project root for license information.\nimport { __awaiter, __extends, __generator } from \"tslib\";\nimport * as utils from \"../util/utils\";\nimport { BaseRequestPolicy } from \"./requestPolicy\";\nexport function systemErrorRetryPolicy(retryCount, retryInterval, minRetryInterval, maxRetryInterval) {\n  return {\n    create: function (nextPolicy, options) {\n      return new SystemErrorRetryPolicy(nextPolicy, options, retryCount, retryInterval, minRetryInterval, maxRetryInterval);\n    }\n  };\n}\n/**\n * @class\n * Instantiates a new \"ExponentialRetryPolicyFilter\" instance.\n *\n * @constructor\n * @param {number} retryCount        The client retry count.\n * @param {number} retryInterval     The client retry interval, in milliseconds.\n * @param {number} minRetryInterval  The minimum retry interval, in milliseconds.\n * @param {number} maxRetryInterval  The maximum retry interval, in milliseconds.\n */\nvar SystemErrorRetryPolicy = /** @class */function (_super) {\n  __extends(SystemErrorRetryPolicy, _super);\n  function SystemErrorRetryPolicy(nextPolicy, options, retryCount, retryInterval, minRetryInterval, maxRetryInterval) {\n    var _this = _super.call(this, nextPolicy, options) || this;\n    _this.DEFAULT_CLIENT_RETRY_INTERVAL = 1000 * 30;\n    _this.DEFAULT_CLIENT_RETRY_COUNT = 3;\n    _this.DEFAULT_CLIENT_MAX_RETRY_INTERVAL = 1000 * 90;\n    _this.DEFAULT_CLIENT_MIN_RETRY_INTERVAL = 1000 * 3;\n    _this.retryCount = typeof retryCount === \"number\" ? retryCount : _this.DEFAULT_CLIENT_RETRY_COUNT;\n    _this.retryInterval = typeof retryInterval === \"number\" ? retryInterval : _this.DEFAULT_CLIENT_RETRY_INTERVAL;\n    _this.minRetryInterval = typeof minRetryInterval === \"number\" ? minRetryInterval : _this.DEFAULT_CLIENT_MIN_RETRY_INTERVAL;\n    _this.maxRetryInterval = typeof maxRetryInterval === \"number\" ? maxRetryInterval : _this.DEFAULT_CLIENT_MAX_RETRY_INTERVAL;\n    return _this;\n  }\n  SystemErrorRetryPolicy.prototype.sendRequest = function (request) {\n    var _this = this;\n    return this._nextPolicy.sendRequest(request.clone()).catch(function (error) {\n      return retry(_this, request, error.response, error);\n    });\n  };\n  return SystemErrorRetryPolicy;\n}(BaseRequestPolicy);\nexport { SystemErrorRetryPolicy };\n/**\n * Determines if the operation should be retried and how long to wait until the next retry.\n *\n * @param {number} statusCode The HTTP status code.\n * @param {RetryData} retryData  The retry data.\n * @return {boolean} True if the operation qualifies for a retry; false otherwise.\n */\nfunction shouldRetry(policy, retryData) {\n  var currentCount;\n  if (!retryData) {\n    throw new Error(\"retryData for the SystemErrorRetryPolicyFilter cannot be null.\");\n  } else {\n    currentCount = retryData && retryData.retryCount;\n  }\n  return currentCount < policy.retryCount;\n}\n/**\n * Updates the retry data for the next attempt.\n *\n * @param {RetryData} retryData  The retry data.\n * @param {object} err        The operation\"s error, if any.\n */\nfunction updateRetryData(policy, retryData, err) {\n  if (!retryData) {\n    retryData = {\n      retryCount: 0,\n      retryInterval: 0\n    };\n  }\n  if (err) {\n    if (retryData.error) {\n      err.innerError = retryData.error;\n    }\n    retryData.error = err;\n  }\n  // Adjust retry count\n  retryData.retryCount++;\n  // Adjust retry interval\n  var incrementDelta = Math.pow(2, retryData.retryCount) - 1;\n  var boundedRandDelta = policy.retryInterval * 0.8 + Math.floor(Math.random() * (policy.retryInterval * 0.4));\n  incrementDelta *= boundedRandDelta;\n  retryData.retryInterval = Math.min(policy.minRetryInterval + incrementDelta, policy.maxRetryInterval);\n  return retryData;\n}\nfunction retry(policy, request, operationResponse, err, retryData) {\n  return __awaiter(this, void 0, void 0, function () {\n    var error_1;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          retryData = updateRetryData(policy, retryData, err);\n          if (!(err && err.code && shouldRetry(policy, retryData) && (err.code === \"ETIMEDOUT\" || err.code === \"ESOCKETTIMEDOUT\" || err.code === \"ECONNREFUSED\" || err.code === \"ECONNRESET\" || err.code === \"ENOENT\"))) return [3 /*break*/, 5];\n          _a.label = 1;\n        case 1:\n          _a.trys.push([1, 3,, 4]);\n          return [4 /*yield*/, utils.delay(retryData.retryInterval)];\n        case 2:\n          _a.sent();\n          return [2 /*return*/, policy._nextPolicy.sendRequest(request.clone())];\n        case 3:\n          error_1 = _a.sent();\n          return [2 /*return*/, retry(policy, request, operationResponse, error_1, retryData)];\n        case 4:\n          return [3 /*break*/, 6];\n        case 5:\n          if (err) {\n            // If the operation failed in the end, return all errors instead of just the last one\n            return [2 /*return*/, Promise.reject(retryData.error)];\n          }\n          return [2 /*return*/, operationResponse];\n        case 6:\n          return [2 /*return*/];\n      }\n    });\n  });\n}","map":{"version":3,"names":["utils","BaseRequestPolicy","systemErrorRetryPolicy","retryCount","retryInterval","minRetryInterval","maxRetryInterval","create","nextPolicy","options","SystemErrorRetryPolicy","_super","__extends","_this","call","DEFAULT_CLIENT_RETRY_INTERVAL","DEFAULT_CLIENT_RETRY_COUNT","DEFAULT_CLIENT_MAX_RETRY_INTERVAL","DEFAULT_CLIENT_MIN_RETRY_INTERVAL","prototype","sendRequest","request","_nextPolicy","clone","catch","error","retry","response","shouldRetry","policy","retryData","currentCount","Error","updateRetryData","err","innerError","incrementDelta","Math","pow","boundedRandDelta","floor","random","min","operationResponse","code","delay","_a","sent","error_1","Promise","reject"],"sources":["C:\\repo\\wihy_ui\\client\\node_modules\\@azure\\ms-rest-js\\lib\\policies\\systemErrorRetryPolicy.ts"],"sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT License. See License.txt in the project root for license information.\n\nimport { HttpOperationResponse } from \"../httpOperationResponse\";\nimport * as utils from \"../util/utils\";\nimport { WebResourceLike } from \"../webResource\";\nimport {\n  BaseRequestPolicy,\n  RequestPolicy,\n  RequestPolicyFactory,\n  RequestPolicyOptionsLike,\n} from \"./requestPolicy\";\n\nexport interface RetryData {\n  retryCount: number;\n  retryInterval: number;\n  error?: RetryError;\n}\n\nexport interface RetryError extends Error {\n  message: string;\n  code?: string;\n  innerError?: RetryError;\n}\n\nexport function systemErrorRetryPolicy(\n  retryCount?: number,\n  retryInterval?: number,\n  minRetryInterval?: number,\n  maxRetryInterval?: number\n): RequestPolicyFactory {\n  return {\n    create: (nextPolicy: RequestPolicy, options: RequestPolicyOptionsLike) => {\n      return new SystemErrorRetryPolicy(\n        nextPolicy,\n        options,\n        retryCount,\n        retryInterval,\n        minRetryInterval,\n        maxRetryInterval\n      );\n    },\n  };\n}\n\n/**\n * @class\n * Instantiates a new \"ExponentialRetryPolicyFilter\" instance.\n *\n * @constructor\n * @param {number} retryCount        The client retry count.\n * @param {number} retryInterval     The client retry interval, in milliseconds.\n * @param {number} minRetryInterval  The minimum retry interval, in milliseconds.\n * @param {number} maxRetryInterval  The maximum retry interval, in milliseconds.\n */\nexport class SystemErrorRetryPolicy extends BaseRequestPolicy {\n  retryCount: number;\n  retryInterval: number;\n  minRetryInterval: number;\n  maxRetryInterval: number;\n  DEFAULT_CLIENT_RETRY_INTERVAL = 1000 * 30;\n  DEFAULT_CLIENT_RETRY_COUNT = 3;\n  DEFAULT_CLIENT_MAX_RETRY_INTERVAL = 1000 * 90;\n  DEFAULT_CLIENT_MIN_RETRY_INTERVAL = 1000 * 3;\n\n  constructor(\n    nextPolicy: RequestPolicy,\n    options: RequestPolicyOptionsLike,\n    retryCount?: number,\n    retryInterval?: number,\n    minRetryInterval?: number,\n    maxRetryInterval?: number\n  ) {\n    super(nextPolicy, options);\n    this.retryCount = typeof retryCount === \"number\" ? retryCount : this.DEFAULT_CLIENT_RETRY_COUNT;\n    this.retryInterval =\n      typeof retryInterval === \"number\" ? retryInterval : this.DEFAULT_CLIENT_RETRY_INTERVAL;\n    this.minRetryInterval =\n      typeof minRetryInterval === \"number\"\n        ? minRetryInterval\n        : this.DEFAULT_CLIENT_MIN_RETRY_INTERVAL;\n    this.maxRetryInterval =\n      typeof maxRetryInterval === \"number\"\n        ? maxRetryInterval\n        : this.DEFAULT_CLIENT_MAX_RETRY_INTERVAL;\n  }\n\n  public sendRequest(request: WebResourceLike): Promise<HttpOperationResponse> {\n    return this._nextPolicy\n      .sendRequest(request.clone())\n      .catch((error) => retry(this, request, error.response, error));\n  }\n}\n\n/**\n * Determines if the operation should be retried and how long to wait until the next retry.\n *\n * @param {number} statusCode The HTTP status code.\n * @param {RetryData} retryData  The retry data.\n * @return {boolean} True if the operation qualifies for a retry; false otherwise.\n */\nfunction shouldRetry(policy: SystemErrorRetryPolicy, retryData: RetryData): boolean {\n  let currentCount;\n  if (!retryData) {\n    throw new Error(\"retryData for the SystemErrorRetryPolicyFilter cannot be null.\");\n  } else {\n    currentCount = retryData && retryData.retryCount;\n  }\n  return currentCount < policy.retryCount;\n}\n\n/**\n * Updates the retry data for the next attempt.\n *\n * @param {RetryData} retryData  The retry data.\n * @param {object} err        The operation\"s error, if any.\n */\nfunction updateRetryData(\n  policy: SystemErrorRetryPolicy,\n  retryData?: RetryData,\n  err?: RetryError\n): RetryData {\n  if (!retryData) {\n    retryData = {\n      retryCount: 0,\n      retryInterval: 0,\n    };\n  }\n\n  if (err) {\n    if (retryData.error) {\n      err.innerError = retryData.error;\n    }\n\n    retryData.error = err;\n  }\n\n  // Adjust retry count\n  retryData.retryCount++;\n\n  // Adjust retry interval\n  let incrementDelta = Math.pow(2, retryData.retryCount) - 1;\n  const boundedRandDelta =\n    policy.retryInterval * 0.8 + Math.floor(Math.random() * (policy.retryInterval * 0.4));\n  incrementDelta *= boundedRandDelta;\n\n  retryData.retryInterval = Math.min(\n    policy.minRetryInterval + incrementDelta,\n    policy.maxRetryInterval\n  );\n\n  return retryData;\n}\n\nasync function retry(\n  policy: SystemErrorRetryPolicy,\n  request: WebResourceLike,\n  operationResponse: HttpOperationResponse,\n  err?: RetryError,\n  retryData?: RetryData\n): Promise<HttpOperationResponse> {\n  retryData = updateRetryData(policy, retryData, err);\n  if (\n    err &&\n    err.code &&\n    shouldRetry(policy, retryData) &&\n    (err.code === \"ETIMEDOUT\" ||\n      err.code === \"ESOCKETTIMEDOUT\" ||\n      err.code === \"ECONNREFUSED\" ||\n      err.code === \"ECONNRESET\" ||\n      err.code === \"ENOENT\")\n  ) {\n    // If previous operation ended with an error and the policy allows a retry, do that\n    try {\n      await utils.delay(retryData.retryInterval);\n      return policy._nextPolicy.sendRequest(request.clone());\n    } catch (error) {\n      return retry(policy, request, operationResponse, error, retryData);\n    }\n  } else {\n    if (err) {\n      // If the operation failed in the end, return all errors instead of just the last one\n      return Promise.reject(retryData.error);\n    }\n    return operationResponse;\n  }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}